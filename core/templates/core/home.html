{% extends 'base.html' %}
{% load custom_tags static %}

{% block title %}Dashboard {{ ano_selecionado }} | Sistema Jur√≠dico{% endblock %}

{% block content %}
<div class="dashboard-container">
    
    <!-- HERO HEADER -->
    <div class="hero-header">
        <div class="hero-content">
            <div>
                <h1 class="hero-title"><i class="fa-solid fa-chart-line"></i> Dashboard Executivo</h1>
                <p class="hero-subtitle text-muted">Vis√£o geral do desempenho e a√ß√µes pendentes</p>
            </div>
            <div class="year-badge"><i class="fa-solid fa-calendar"></i> {{ ano_selecionado }}</div>
        </div>
    </div>
    
    <!-- DASHBOARD GRID -->
    <div class="dashboard-grid">
        
        <!-- SUAS A√á√ïES COM FILTROS -->
        <div class="grid-col-span-12">
            <div class="card">
                <div class="card-header filtros-header">
                    <h5><i class="fa-solid fa-list-check"></i> Suas A√ß√µes</h5>
                    <form method="get" action="" class="filtros-form">
                        <div class="btn-group btn-group-sm">
                            <a href="?periodo=hoje" class="btn {% if valores_filtro.periodo == 'hoje' or not valores_filtro.periodo and not valores_filtro.data_inicio %}btn-primary{% else %}btn-outline-secondary{% endif %}"><i class="fa-solid fa-calendar-day"></i> Hoje</a>
                            <a href="?periodo=semana" class="btn {% if valores_filtro.periodo == 'semana' %}btn-primary{% else %}btn-outline-secondary{% endif %}"><i class="fa-solid fa-calendar-week"></i> Semana</a>
                            <a href="?periodo=mes" class="btn {% if valores_filtro.periodo == 'mes' %}btn-primary{% else %}btn-outline-secondary{% endif %}"><i class="fa-solid fa-calendar-alt"></i> M√™s</a>
                        </div>
                        <input type="date" name="data_inicio" class="form-control form-control-sm" value="{{ valores_filtro.data_inicio }}" placeholder="Data in√≠cio">
                        <span class="text-muted">at√©</span>
                        <input type="date" name="data_fim" class="form-control form-control-sm" value="{{ valores_filtro.data_fim }}" placeholder="Data fim">
                        <button type="submit" class="btn btn-sm btn-outline-primary" title="Filtrar por data"><i class="fa-solid fa-filter"></i> Filtrar</button>
                    </form>
                </div>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Caso</th>
                                <th>A√ß√£o</th>
                                <th class="text-center">Prazo</th>
                                <th class="text-right">Acessar</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for acao_inst in acoes_filtradas %}
                            <tr>
                                <td class="caso-details-cell">
                                    <strong>#{{ acao_inst.caso.id|stringformat:"05d" }}</strong>
                                    <small>{{ acao_inst.caso.cliente.nome }} | {{ acao_inst.caso.produto.nome }}</small>
                                </td>
                                <td>{{ acao_inst.acao.titulo|truncatechars:40 }}</td>
                                <td class="text-center">
                                    {% with prazo=acao_inst.data_prazo %}
                                        {% if prazo %}{% with dias_restantes=prazo|days_until %}
                                            <span class="badge {% if dias_restantes < 0 %}bg-dark{% elif dias_restantes == 0 %}bg-danger{% elif dias_restantes < 7 %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                                <i class="fa-solid fa-calendar-check"></i> {{ prazo|date:"d/m/Y" }}
                                            </span>
                                        {% endwith %}{% endif %}
                                    {% endwith %}
                                </td>
                                <td class="text-right">
                                    <a href="{% url 'casos:detalhe_caso' pk=acao_inst.caso.pk %}?aba=acoes" class="btn action-btn btn-info btn-sm"><i class="fa-solid fa-arrow-right"></i> Ir</a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4"><div class="empty-state"><i class="fa-solid fa-check-circle"></i><p>üéâ Nenhuma a√ß√£o encontrada para o per√≠odo selecionado.</p></div></td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- TABELA DE PERFORMANCE -->
        <div class="grid-col-span-12">
            {% for advogado, registros in tabela_performance.items %}
                <div class="card mt-4">
                    <h3 class="section-title"><i class="fa-solid fa-user-tie"></i> Casos por: <strong>{{ advogado }}</strong></h3>
                    <div class="data-table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Produto</th>
                                    <th>Status</th>
                                    <th class="text-right">Qtd. Casos</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for registro in registros %}
                                <tr>
                                    <td>{{ registro.cliente }}</td>
                                    <td>{{ registro.produto }}</td>
                                    <td><span class="badge {% if registro.status == 'ATIVO' %}bg-success{% elif registro.status == 'ENCERRADO' %}bg-secondary{% else %}bg-warning{% endif %}">{{ registro.status }}</span></td>
                                    <td class="text-right"><strong>{{ registro.total }}</strong></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% empty %}
                <div class="card grid-col-span-12"><div class="empty-state"><i class="fa-solid fa-chart-bar"></i><p>Nenhum dado de performance encontrado.</p></div></div>
            {% endfor %}
        </div>
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
{# Depend√™ncia externa para o gr√°fico #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{# Passando dados do Django para o JavaScript de forma segura #}
{% if dados_grafico_pizza %}
    {{ pizza_labels|json_script:"chart-pizza-labels" }}
    {{ pizza_data|json_script:"chart-pizza-data" }}
{% endif %}

{# Nosso script customizado da p√°gina #}
<script src="{% static 'js/dashboard.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Coleta os dados do gr√°fico do DOM
        const labelsEl = document.getElementById('chart-pizza-labels');
        const dataEl = document.getElementById('chart-pizza-data');
        const chartData = (labelsEl && dataEl) ? {
            labels: JSON.parse(labelsEl.textContent),
            data: JSON.parse(dataEl.textContent)
        } : null;

        // Inicializa o script do dashboard
        initDashboard({
            chartData: chartData,
            urls: {
                periods: {
                    hoje: "?periodo=hoje",
                    semana: "?periodo=semana",
                    mes: "?periodo=mes"
                }
            }
        });
    });
</script>
{% endblock %}
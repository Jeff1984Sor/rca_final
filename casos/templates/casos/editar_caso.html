{% extends "base.html" %}
{% load static %}
{% load custom_tags %}

{% block title %}Editar Caso{% endblock %}

{% block extra_css %}
<style>
/* Estilos para o prazo no cabeçalho */
.case-header-actions {
    display: flex;
    align-items: center;
    gap: 24px;
}
.prazo-header-destaque {
    text-align: right;
}
.prazo-header-destaque small {
    display: block;
    font-size: 0.8rem;
    color: #64748b; /* text-medium */
    text-transform: uppercase;
    font-weight: 600;
    line-height: 1;
}
.prazo-header-destaque .prazo-data {
    font-size: 1.75rem;
    font-weight: 700;
    color: #ef4444; /* danger-color */
    line-height: 1.2;
}
</style>
{% endblock %}


{% block content %}
<div class="container-fluid mt-4">
  <div class="row justify-content-center">
    <div class="col-xl-10 col-lg-11 col-md-12">

      {% include 'casos/partials/app_messages.html' %}

      <div class="card shadow-sm border-0 mb-4">
        
        <div class="card-header bg-light">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="mb-0">Editar Caso</h4>
              <small class="text-muted">{{ caso.cliente.nome }} / {{ caso.produto.nome }}</small>
            </div>
            <div class="case-header-actions">
                {% if caso.prazo_final_calculado %}
                    <div class="prazo-header-destaque">
                        <small>Prazo Final Atual</small>
                        <div class="prazo-data">
                            {{ caso.prazo_final_calculado|date:"d/m/Y" }}
                        </div>
                    </div>
                {% endif %}
            </div>
          </div>
        </div>

        <form method="post" action="" class="needs-validation" novalidate>
          {% csrf_token %}

          <div class="card-body p-4">
            <h5 class="mb-4 border-bottom pb-2">Dados Principais do Caso</h5>
            <div class="row g-3">
              
              <!-- ESTE LOOP AGORA RENDERIZA TODOS OS CAMPOS FIXOS, INCLUINDO 'valor_apurado' -->
              {% for field in form.campos_fixos %}
                <div class="col-md-6">
                  <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                  {{ field }}
                  {% if field.errors %}
                    <div class="text-danger small">{{ field.errors }}</div>
                  {% endif %}
                </div>
              {% endfor %}
              
            </div>

            <hr class="my-4">

            <h5 class="mb-4 border-bottom pb-2">Dados Adicionais</h5>
            <div class="row g-3">
              {# Este loop renderiza os campos personalizados restantes (que não são mais o valor_apurado) #}
              {% for field in form.campos_personalizados_simples %}
                  <div class="col-md-6">
                    <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                    {{ field }}
                    {% if field.errors %}<div class="text-danger small">{{ field.errors }}</div>{% endif %}
                  </div>
              {% endfor %}
            </div>

            <!-- Grupos repetíveis (SEM MUDANÇAS) -->
            {% for grupo, formset in grupo_formsets %}
              <hr class="my-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">{{ grupo.nome_grupo }}</h5>
                <button type="button" class="btn btn-outline-success btn-sm add-grupo-btn"
                        data-formset-prefix="{{ formset.prefix }}"
                        data-grupo-id="{{ grupo.id }}">
                  <i class="fas fa-plus me-1"></i> Adicionar {{ grupo.nome_grupo|truncatechars:15 }}
                </button>
              </div>

              {{ formset.management_form }}

              <div id="formset-container-{{ grupo.id }}">
                {% for form_grupo in formset %}
                  <div class="grupo-form p-3 border rounded bg-light mb-3">
                    {% if formset.can_delete %}
                      <div class="d-none">{{ form_grupo.DELETE }}</div>
                    {% endif %}
                    <div class="d-flex flex-wrap align-items-end">
                      {% for field in form_grupo.visible_fields %}
                        <div class="me-3 mb-2" style="flex-grow: 1; min-width: 200px;">
                          <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                          {{ field }}
                          {% if field.errors %}
                            <div class="text-danger small">{{ field.errors }}</div>
                          {% endif %}
                        </div>
                      {% endfor %}
                      <div class="ms-auto">
                        <button type="button" class="btn btn-danger delete-grupo-btn">
                          <i class="fas fa-trash"></i> Remover
                        </button>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <div id="empty-form-{{ grupo.id }}" style="display:none;">
                <div class="grupo-form p-3 border rounded bg-light mb-3">
                  {% if formset.can_delete %}
                    <div class="d-none">{{ formset.empty_form.DELETE }}</div>
                  {% endif %}
                  <div class="d-flex flex-wrap align-items-end">
                    {% for field in formset.empty_form.visible_fields %}
                      <div class="me-3 mb-2" style="flex-grow: 1; min-width: 200px;">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                        {{ field }}
                      </div>
                    {% endfor %}
                    <div class="ms-auto">
                      <button type="button" class="btn btn-danger delete-grupo-btn">
                        <i class="fas fa-trash"></i> Remover
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="card-footer text-end">
            <a href="{% url 'casos:detalhe_caso' pk=caso.pk %}" class="btn btn-secondary">
              <i class="fas fa-times me-1"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="fas fa-save me-2"></i> Salvar Alterações
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// SEU JAVASCRIPT ORIGINAL - SEM NENHUMA MUDANÇA
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.add-grupo-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      var prefix = this.dataset.formsetPrefix;
      var grupoId = this.dataset.grupoId;
      var container = document.getElementById('formset-container-' + grupoId);
      var totalFormsInput = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
      var currentFormCount = parseInt(totalFormsInput.value, 10);
      var emptyFormHtml = document.getElementById('empty-form-' + grupoId)?.innerHTML;
      if (!emptyFormHtml) return;
      var newFormHtml = emptyFormHtml.replace(/__prefix__/g, currentFormCount);
      var tempWrapper = document.createElement('div');
      tempWrapper.innerHTML = newFormHtml;
      var newFormElement = tempWrapper.firstElementChild;
      container.appendChild(newFormElement);
      totalFormsInput.value = currentFormCount + 1;
    });
  });

  document.body.addEventListener('click', function(event) {
    var btn = event.target.closest('.delete-grupo-btn');
    if (!btn) return;
    event.preventDefault();
    var formWrapper = btn.closest('.grupo-form');
    if (!formWrapper) return;
    var deleteInput = formWrapper.querySelector('input[name$="-DELETE"]');
    if (deleteInput) {
      if (deleteInput.type === 'hidden') {
        deleteInput.value = 'on';
      } else {
        deleteInput.checked = true;
      }
      formWrapper.style.display = 'none';
    } else {
      formWrapper.remove();
    }
  });
});
</script>
{% endblock %}
{% extends "base.html" %}
{% load static %}
{% load custom_tags %}

{% block title %}Editar Caso{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row justify-content-center">
    <div class="col-xl-10 col-lg-11 col-md-12">

      {% include 'casos/partials/app_messages.html' %}

      <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-light">
          <h4 class="mb-0">Editar Caso</h4>
          <small class="text-muted">{{ caso.cliente.nome }} / {{ caso.produto.nome }}</small>
        </div>

        <!-- ✅ FORM correto -->
        <form method="post" action="" class="needs-validation" novalidate>
          {% csrf_token %}

          <div class="card-body p-4">
            <!-- Dados principais -->
            <h5 class="mb-4 border-bottom pb-2">Dados Principais do Caso</h5>
            <div class="row g-3">
              {% for field in form.campos_fixos %}
                <div class="col-md-6">
                  <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                  {{ field }}
                  {% if field.errors %}
                    <div class="text-danger small">{{ field.errors }}</div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>

            <hr class="my-4">

            <!-- Dados adicionais -->
            <h5 class="mb-4 border-bottom pb-2">Dados Adicionais</h5>
            <div class="row g-3">
              {% for field in form.campos_personalizados_simples %}
                <div class="col-md-6">
                  <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                  {{ field }}
                  {% if field.errors %}
                    <div class="text-danger small">{{ field.errors }}</div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>

            <!-- Grupos repetíveis -->
            {% for grupo, formset in grupo_formsets %}
              <hr class="my-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">{{ grupo.nome_grupo }}</h5>
                <button type="button" class="btn btn-outline-success btn-sm add-grupo-btn"
                        data-formset-prefix="{{ formset.prefix }}"
                        data-grupo-id="{{ grupo.id }}">
                  <i class="fas fa-plus me-1"></i> Adicionar {{ grupo.nome_grupo|truncatechars:15 }}
                </button>
              </div>

              {{ formset.management_form }}

              <div id="formset-container-{{ grupo.id }}">
                {% for form_grupo in formset %}
                  <div class="grupo-form p-3 border rounded bg-light mb-3">
                    {% if formset.can_delete %}
                      <div class="d-none">{{ form_grupo.DELETE }}</div> {# ✅ checkbox escondido #}
                    {% endif %}
                    <div class="d-flex flex-wrap align-items-end">
                      {% for field in form_grupo.visible_fields %}
                        <div class="me-3 mb-2" style="flex-grow: 1; min-width: 200px;">
                          <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                          {{ field }}
                          {% if field.errors %}
                            <div class="text-danger small">{{ field.errors }}</div>
                          {% endif %}
                        </div>
                      {% endfor %}
                      <div class="ms-auto">
                        <button type="button" class="btn btn-danger delete-grupo-btn">
                          <i class="fas fa-trash"></i> Remover
                        </button>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>

              <!-- Empty form com widgets completos -->
              <div id="empty-form-{{ grupo.id }}" style="display:none;">
                <div class="grupo-form p-3 border rounded bg-light mb-3">
                  {% if formset.can_delete %}
                    <div class="d-none">{{ formset.empty_form.DELETE }}</div> {# ✅ checkbox escondido #}
                  {% endif %}
                  <div class="d-flex flex-wrap align-items-end">
                    {% for field in formset.empty_form.visible_fields %}
                      <div class="me-3 mb-2" style="flex-grow: 1; min-width: 200px;">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                        {{ field }}
                      </div>
                    {% endfor %}
                    <div class="ms-auto">
                      <button type="button" class="btn btn-danger delete-grupo-btn">
                        <i class="fas fa-trash"></i> Remover
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <div class="card-footer text-end">
            {% url 
              <i class="fas fa-times me-1"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="fas fa-save me-2"></i> Salvar Alterações
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.add-grupo-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      var prefix = this.dataset.formsetPrefix;
      var grupoId = this.dataset.grupoId;
      var container = document.getElementById('formset-container-' + grupoId);
      var totalFormsInput = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
      var currentFormCount = parseInt(totalFormsInput.value, 10);

      var emptyFormHtml = document.getElementById('empty-form-' + grupoId)?.innerHTML;
      if (!emptyFormHtml) return;

      var newFormHtml = emptyFormHtml.replace(/__prefix__/g, currentFormCount);
      var tempWrapper = document.createElement('div');
      tempWrapper.innerHTML = newFormHtml;
      var newFormElement = tempWrapper.firstElementChild;

      container.appendChild(newFormElement);
      totalFormsInput.value = currentFormCount + 1;
    });
  });

  document.body.addEventListener('click', function(event) {
    var btn = event.target.closest('.delete-grupo-btn');
    if (!btn) return;

    event.preventDefault();
    var formWrapper = btn.closest('.grupo-form');
    if (!formWrapper) return;

    var deleteInput = formWrapper.querySelector('input[name$="-DELETE"]');
    if (deleteInput) {
      if (deleteInput.type === 'hidden') {
        deleteInput.value = 'on';   // caso tenha ficado hidden
      } else {
        deleteInput.checked = true; // se for checkbox (recomendado)
      }
      formWrapper.style.display = 'none';
    } else {
      // item novo (ainda não salvo) -> remover do DOM
      formWrapper.remove();
      // opcional: decrementar TOTAL_FORMS (só se remover o último adicionado)
    }
  });
});
</script>
{% endblock %}
``
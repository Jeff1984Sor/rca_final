{% extends "base.html" %}
{% load static custom_tags %}

{% block title %}Editar Caso #{{ caso.id }} | {{ caso.titulo }}{% endblock %}

{% block content %}

    
    <!-- HERO HEADER -->
    <div class="hero-header">
        <div class="hero-content">
            <div class="hero-left">
                <div class="case-badge"><i class="fa-solid fa-pen-to-square"></i> Editando Caso #{{ caso.id }}</div>
                <h1 class="hero-title">{{ caso.titulo|default:"Caso sem título" }}</h1>
                <div class="hero-meta">
                    <div class="meta-item"><i class="fa-solid fa-building"></i> <strong>{{ caso.cliente.nome }}</strong></div>
                    <div class="meta-item"><i class="fa-solid fa-box"></i> <strong>{{ caso.produto.nome }}</strong></div>
                    <div class="meta-item"><i class="fa-solid fa-calendar"></i> {{ caso.data_entrada|date:"d/m/Y" }}</div>
                </div>
            </div>
            {% if caso.prazo_final_calculado %}
            <div class="hero-prazo-card">
                <div class="prazo-label"><i class="fa-solid fa-clock"></i> Prazo Final</div>
                <div class="prazo-value">{{ caso.prazo_final_calculado|date:"d/m" }}</div>
                <div class="prazo-status">{{ caso.prazo_final_calculado|date:"Y" }}</div>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- MENSAGENS -->
    {% include 'casos/partials/app_messages.html' %}
    
    <!-- FORM CARD -->
    <div class="form-card">
        <form method="post" action="" class="needs-validation" novalidate>
            {% csrf_token %}
            <div class="card-content">
                <!-- DADOS PRINCIPAIS -->
                <div class="form-section">
                    <div class="section-header"><i class="fa-solid fa-circle-info"></i><h2 class="section-title">Dados Principais do Caso</h2></div>
                    <div class="fields-grid">
                        {% for field in form.campos_fixos %}{% include "_form_field.html" with field=field icon="tag" %}{% endfor %}
                    </div>
                </div>
                <!-- DADOS ADICIONAIS -->
                <div class="form-section">
                    <div class="section-header"><i class="fa-solid fa-sliders"></i><h2 class="section-title">Dados Adicionais</h2></div>
                    <div class="fields-grid">
                        {% for field in form.campos_personalizados_simples %}{% include "_form_field.html" with field=field icon="circle-dot" %}{% endfor %}
                    </div>
                </div>
                <!-- GRUPOS REPETÍVEIS -->
                {% if grupo_formsets %}{% for grupo, formset in grupo_formsets %}
                <div class="grupo-repetiveis-section">
                    <div class="grupo-header">
                        <h3 class="grupo-title"><i class="fa-solid fa-layer-group"></i> {{ grupo.nome_grupo }}</h3>
                        <button type="button" class="btn btn-success add-grupo-btn" data-formset-prefix="{{ formset.prefix }}" data-grupo-id="{{ grupo.id }}"><i class="fa-solid fa-plus-circle"></i> Adicionar Item</button>
                    </div>
                    {{ formset.management_form }}
                    <div id="formset-container-{{ grupo.id }}">
                        {% for form_grupo in formset %}<div class="grupo-item grupo-form">
                            {% if formset.can_delete %}<div style="display: none;">{{ form_grupo.DELETE }}</div>{% endif %}
                            <div class="grupo-item-header">
                                <div class="grupo-item-number"><i class="fa-solid fa-hashtag"></i> Item {{ forloop.counter }}</div>
                                <button type="button" class="btn btn-sm btn-danger delete-grupo-btn"><i class="fa-solid fa-trash-alt"></i> Remover</button>
                            </div>
                            <div class="fields-grid">
                                {% for field in form_grupo.visible_fields %}{% include "_form_field.html" with field=field icon="circle-dot" %}{% endfor %}
                            </div>
                        </div>{% endfor %}
                    </div>
                    <div id="empty-form-{{ grupo.id }}" style="display:none;"><div class="grupo-item grupo-form">
                        {% if formset.can_delete %}<div style="display: none;">{{ formset.empty_form.DELETE }}</div>{% endif %}
                        <div class="grupo-item-header">
                            <div class="grupo-item-number"><i class="fa-solid fa-hashtag"></i> Novo Item</div>
                            <button type="button" class="btn btn-sm btn-danger delete-grupo-btn"><i class="fa-solid fa-trash-alt"></i> Remover</button>
                        </div>
                        <div class="fields-grid">
                            {% for field in formset.empty_form.visible_fields %}{% include "_form_field.html" with field=field icon="circle-dot" %}{% endfor %}
                        </div>
                    </div></div>
                </div>
                {% endfor %}{% endif %}
            </div>
            <!-- FOOTER -->
            <div class="form-footer">
                <a href="{% url 'casos:detalhe_caso' pk=caso.pk %}" class="btn btn-outline-secondary"><i class="fa-solid fa-times-circle"></i> Cancelar</a>
                <button type="submit" class="btn btn-primary" style="background: var(--warning);"><i class="fa-solid fa-save"></i> Salvar Alterações</button>
            </div>
        </form>
    </div>
    
    <!-- INDICADOR DE EDIÇÃO -->
    <div class="editing-indicator"><i class="fa-solid fa-pen"></i> Modo de Edição</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/form_editar_caso.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initEditarCasoForm({
            cancelUrl: "{% url 'casos:detalhe_caso' pk=caso.pk %}"
        });
    });
</script>
{% endblock %}
{% extends 'base.html' %}
{% load currency_tags %}
{% load file_icons %}


{% block title %}Detalhes do Caso #{{ caso.id }}{% endblock %}

{% block extra_css %}
<style>
    /* ===================================================================== */
    /* === CSS MODERNO E COMPLETO PARA A TELA DE DETALHES DO CASO === */
    /* ===================================================================== */

    :root {
        --primary-color: #3b82f6; /* Azul vibrante */
        --warning-color: #f59e0b; /* Amarelo/Laranja */
        --danger-color: #ef4444; /* Vermelho */
        --success-color: #10b981; /* Verde */
        --info-color: #0ea5e9; /* Ciano */
        
        --text-dark: #1e293b; /* Quase preto */
        --text-medium: #64748b;
        --text-light: #94a3b8;
        
        --bg-main: #f1f5f9; /* Fundo principal da página */
        --bg-card: #ffffff; /* Fundo dos cards */
        --bg-subtle: #f8fafc; /* Fundo de elementos internos, como cabeçalhos */
        --border-color: #e2e8f0;
    }

    /* ----- ESTRUTURA GERAL ----- */
    h1, h2, h3, h4, h5, h6 { color: var(--text-dark); }
    hr { border: none; border-top: 1px solid var(--border-color); margin: 30px 0; }

    /* ----- CABEÇALHO DO CASO ----- */
    .case-header {
        background-color: var(--bg-card);
        padding: 24px 32px;
        margin-bottom: 24px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.03);
    }
    .case-header-content { display: flex; justify-content: space-between; align-items: center; }
    .case-header h1 { font-size: 2rem; font-weight: 700; }
    .case-header h1 span { color: var(--primary-color); }
    .case-header p { font-size: 1.1rem; color: var(--text-medium); margin-top: 4px; }
    .btn-edit-header { 
        background-color: var(--warning-color); color: white; padding: 12px 24px; text-decoration: none;
        border-radius: 8px; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;
    }
    .btn-edit-header:hover { background-color: #d97706; transform: translateY(-2px); box-shadow: 0 7px 14px rgba(0,0,0,0.1); }

    /* ----- NAVEGAÇÃO POR ABAS ----- */
    .tab-nav { border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
    .tab-nav button { background-color: transparent; border: none; padding: 15px 20px; cursor: pointer; font-size: 1rem; margin-bottom: -1px; color: var(--text-medium); font-weight: 600; }
    .tab-nav button.active { border-bottom: 3px solid var(--primary-color); color: var(--primary-color); }
    
    .tab-content { display: none; }
    .js-enabled .tab-content:not(.active) { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.4s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* ----- COMPONENTES REUTILIZÁVEIS ----- */
    .form-section, .list-section { background-color: var(--bg-card); border: 1px solid var(--border-color); padding: 25px 30px; margin-bottom: 25px; border-radius: 12px; }
    .section-title { font-size: 1.5rem; color: var(--text-dark); margin-bottom: 24px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
    .form-row { display: flex; flex-wrap: wrap; gap: 20px; }
    .form-group { flex: 1; min-width: 200px; margin-bottom: 15px; }
    .form-group label { font-weight: 600; display: block; margin-bottom: 8px; font-size: 0.9em; color: #486581; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #dce4f2; box-sizing: border-box; font-size: 1rem; transition: border-color 0.2s, box-shadow 0.2s; background-color: var(--bg-subtle); }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { background-color: white; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59,130,246,.25); outline: none; }
    .btn-submit { padding: 12px 24px; font-size: 1rem; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: opacity 0.2s; }
    .btn-submit:hover { opacity: 0.85; }
    .list-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .list-toolbar h3 { margin: 0; font-size: 1.5em; }
    .btn-export { background-color: var(--info-color); }
    .btn-pdf { background-color: var(--danger-color); }

    .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.95rem; }
    .data-table th, .data-table td { border-bottom: 1px solid var(--border-color); padding: 15px; text-align: left; }
    .data-table thead th { color: var(--text-medium); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }
    .data-table tbody tr:hover { background-color: var(--bg-subtle); }
    td.actions { white-space: nowrap; text-align: right; }
    .action-btn { padding: 6px 12px; font-size: 0.85em; text-decoration: none; border-radius: 5px; color: white; display: inline-block; text-align: center; transition: opacity 0.2s; font-weight: 500; }
    .action-btn:hover { opacity: 0.8; }
    .btn-edit { background-color: var(--warning-color); color: white; }
    .btn-delete { background-color: var(--danger-color); color: white; margin-left: 5px; }

    .summary-box { text-align: left; padding: 24px; background-color: var(--bg-subtle); border-radius: 8px; border-left: 4px solid var(--primary-color); }
    .summary-box h3 { font-size: 1rem; color: var(--text-medium); text-transform: uppercase; font-weight: 600; }
    .summary-box p { font-size: 2.5rem; color: var(--text-dark); font-weight: 700; }

    /* ----- ESTILOS ESPECÍFICOS POR ABA ----- */
    .detail-item {
        display: flex; /* Ativa o Flexbox */
        align-items: baseline; /* Alinha pela base do texto */
        gap: 8px; /* Cria um espaço entre o rótulo e o valor */
        margin-bottom: 10px;
    }
    .detail-item label { 
        font-size: 0.85rem; 
        color: var(--text-light); /* Cinza claro, como está */
        text-transform: uppercase; 
        letter-spacing: 0.5px;
        flex-shrink: 0; /* Impede que o rótulo encolha */
    }
    .detail-item span { 
        font-size: 1rem; 
        color: var(--text-dark); /* Texto escuro, quase preto */
        font-weight: 500; 
    }

    .item-card { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; }
    .item-card-header { background-color: var(--bg-subtle); padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .item-card-header-info strong { font-size: 1.1em; color: var(--text-dark); }
    .item-card-header-info small { font-size: 0.85em; color: var(--text-medium); }
    .andamento-body { padding: 20px; white-space: pre-wrap; line-height: 1.6; }
    .acordo-body { padding: 0; }
    .acordo-body table tbody tr { cursor: pointer; }
    .parcela-quitada { background-color: #d1fae5 !important; color: #065f46; text-decoration: line-through; }

    .despesa { background-color: var(--warning-color); }
    
    /* Anexos */
    .anexos-container { display: flex; gap: 20px; min-height: 60vh; }
    #file-list-panel { flex: 1; padding: 20px; background: var(--bg-subtle); border-radius: 8px; border: 1px solid var(--border-color); }
    #preview-panel { flex: 1; border: 1px solid var(--border-color); border-radius: 8px; display: flex; align-items: center; justify-content: center; background-color: var(--bg-subtle); }
    .preview-placeholder { text-align: center; color: #cbd5e1; }
    .preview-placeholder i { font-size: 4em; }
    #preview-panel iframe { width: 100%; height: 100%; border: none; border-radius: 8px;}
    .file-browser-toolbar { display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; }
    .folder-nav { display: flex; align-items: center; }
    .back-button { margin-right: 15px; text-decoration: none; color: #555; font-size: 1.2em; }
    .new-folder-form { display: flex; align-items: center; gap: 5px; }
    .new-folder-form input[type="text"] { padding: 8px; }
    .upload-form-container { padding: 15px; background-color: #f8fafc; border-radius: 8px; border: 2px dashed #dce4f2; margin-bottom: 20px; }
    .upload-form-container form { display: flex; align-items: center; gap: 15px; }
    input[type="file"] { display: none; }
    .upload-label { background-color: #6c757d; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .upload-label:hover { background-color: #5a6268; }
    .file-list-preview { font-size: 0.9em; color: #555; flex-grow: 1; }
    .progress-container { flex-grow: 1; display: flex; align-items: center; gap: 10px; }
    #progress-bar { width: 100%; height: 10px; }

    .file-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 15px;
    }
    .grid-item { position: relative; text-align: center; }
    .grid-item-link { display: flex; flex-direction: column; align-items: center; padding: 15px 10px; background-color: #f8fafc; border-radius: 8px; text-decoration: none; color: #334e68; border: 1px solid #eee; transition: all 0.2s ease-in-out; }
    .grid-item-link:hover { background-color: #e9ecef; border-color: #007bff; transform: translateY(-5px); }
    .icon-container { font-size: 2.5em; margin-bottom: 10px; color: #007bff; }
    .icon-container .fa-folder { color: #f59e0b; }
    .item-name { font-size: 0.85em; word-break: break-all; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: 2.5em; }
    .delete-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.9em; opacity: 0; transition: opacity 0.2s; }
    .grid-item:hover .delete-btn { opacity: 1; }

    .fase-atual-nome { color: var(--primary-color); }
    .acoes-section { margin-bottom: 30px; }
    .section-title { font-size: 1.2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; color: var(--text-medium); text-transform: uppercase; letter-spacing: 1px; }
    .acao-pendente { border-left: 4px solid var(--warning-color); }
    .icon-pendente { color: var(--warning-color); }
    .acao-concluida { border-left: 4px solid var(--success-color); }
    .icon-concluida { color: var(--success-color); }
    .concluida-info { margin-left: auto; font-size: 0.85em; color: var(--text-medium); }
    .comentario-concluido { background-color: var(--bg-subtle); border-left: 3px solid var(--border-color); padding: 10px; margin-top: 10px; font-size: 0.9em; white-space: pre-wrap; border-radius: 4px; }
    .btn-sim { background-color: var(--success-color); }
    .btn-nao { background-color: var(--danger-color); }
    .empty-state { padding: 40px; text-align: center; color: var(--text-medium); border: 2px dashed var(--border-color); border-radius: 8px; }
    .workflow-timeline { border-left: 3px solid var(--border-color); }
    .timeline-icon { border: 4px solid var(--bg-main); left: -18.5px; }
    .fase-atual .timeline-icon { background-color: var(--primary-color); }

        /* Estilos para a Aba de Fluxo Interno */
    .fluxo-timeline {
        position: relative;
        padding-left: 30px;
        border-left: 3px solid #e9ecef;
    }
    /* Reutiliza o .timeline-item e .timeline-icon do workflow */
    .fluxo-timeline .timeline-content h4 {
        margin: 0 0 8px;
        font-size: 1.1em;
        color: var(--text-dark);
    }
    .fluxo-descricao {
        background-color: var(--bg-subtle);
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 8px;
        white-space: pre-wrap;
    }
    .fluxo-meta {
        font-size: 0.85em;
        color: var(--text-medium);
    }
    .fluxo-timeline .timeline-icon {
        background-color: var(--primary-color);
    }
</style>
{% endblock %}

{% block content %}
    <!-- CABEÇALHO DO CASO -->
    <div class="card case-header">
        <div class="case-header-content">
            <div><h1><span>#{{ caso.id }}</span> - {{ caso.titulo|default:"(Caso sem título)" }}</h1><p><strong>Cliente:</strong> {{ caso.cliente.nome }} | <strong>Produto:</strong> {{ caso.produto.nome }}</p></div>
            <div><a href="{% url 'casos:editar_caso' pk=caso.pk %}" class="btn-edit-header">Editar Caso</a></div>
        </div>
    </div>

    <!-- NAVEGAÇÃO POR ABAS -->
    <div class="tab-nav">
        <button class="tab-button" data-tab="detalhes">Detalhes</button>
        <button class="tab-button" data-tab="acoes">Ações</button>
        <button class="tab-button" data-tab="workflow">Workflow</button>
        <button class="tab-button" data-tab="fluxo-interno">Fluxo Interno</button>
        <button class="tab-button" data-tab="andamentos">Andamentos</button>
        <button class="tab-button" data-tab="timesheet">Timesheet</button>
        <button class="tab-button" data-tab="acordos">Acordos</button>
        <button class="tab-button" data-tab="despesas">Despesas</button>
        <button class="tab-button" data-tab="anexos">Anexos</button>
    </div>

    <!-- Aba 1: Detalhes -->
    <!-- Aba 1: Detalhes (VERSÃO FINAL COM FORMATAÇÃO DE MOEDA) -->
    <div id="detalhes" class="tab-content">
        <div class="form-section">
            <h3 class="section-title">Dados do Caso</h3>
            <div class="details-grid">
                <div class="detail-item"><label>Status</label><span>{{ caso.get_status_display }}</span></div>
                <div class="detail-item"><label>Data de Entrada</label><span>{{ caso.data_entrada|date:"d/m/Y" }}</span></div>
                <div class="detail-item"><label>Fase do Workflow</label><span>{{ caso.fase_atual_wf.nome|default:"Não iniciado" }}</span></div>
                <div class="detail-item"><label>Advogado Responsável</label><span>{% if caso.advogado_responsavel %}{{ caso.advogado_responsavel.get_full_name|default:caso.advogado_responsavel.username }}{% else %}Não atribuído{% endif %}</span></div>
                <div class="detail-item"><label>Data de Encerramento</label><span>{{ caso.data_encerramento|date:"d/m/Y"|default:"-" }}</span></div>
            </div>
        </div>
        {% if valores_personalizados %}
        <div class="form-section">
            <h3 class="section-title">Dados Adicionais</h3>
            <div class="details-grid">
                {% for valor in valores_personalizados %}
                    <div class="detail-item">
                        <label>{{ valor.campo.nome_campo }}</label>
                        <span>
                            {% if valor.campo.tipo_campo == 'DATA' %}
                                {{ valor.valor_tratado|date:"d/m/Y"|default:"-" }}
                            {% elif valor.campo.tipo_campo == 'MOEDA' %}
                                {{ valor.valor_tratado|currency }}
                            {% else %}
                                {{ valor.valor_tratado|default:"-" }}
                            {% endif %}
                        </span>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Aba 2: Ações -->
    <div id="acoes" class="tab-content">
        <div id="painel-acoes">{% include 'workflow/partials/painel_acoes.html' %}</div>
    </div>

    <!-- Aba 3: Workflow -->
    <div id="workflow" class="tab-content">
        <h3 class="section-title">Linha do Tempo do Workflow</h3>
        <div class="workflow-timeline">
            {% for historico in historico_fases %}<div class="timeline-item {% if not historico.data_saida %}fase-atual{% endif %}"><div class="timeline-icon"><i class="fa-solid fa-circle-check"></i></div><div class="timeline-content"><h3>{{ historico.fase.nome }}</h3><p>Entrou em: {{ historico.data_entrada|date:"d/m/Y H:i" }}{% if not historico.data_saida %}<span class="tempo-na-fase"> ({{ historico.data_entrada|tempo_decorrido }})</span>{% endif %}</p></div></div>{% empty %}<div class="empty-state"><p>O workflow para este caso ainda não foi iniciado.</p></div>{% endfor %}
        </div>
    </div>

    <div id="fluxo-interno" class="tab-content card">
    <h3 class="section-title">Linha do Tempo Completa do Caso</h3>
    
    <div class="fluxo-timeline">
            {% for evento in fluxo_interno %}
                <div class="timeline-item">
                    <!-- Ícone do Evento -->
                    <div class="timeline-icon">
                        {% if evento.tipo_evento == 'CRIACAO_CASO' %}<i class="fa-solid fa-star"></i>
                        {% elif evento.tipo_evento == 'MUDANCA_FASE_WF' %}<i class="fa-solid fa-route"></i>
                        {% elif evento.tipo_evento == 'ACAO_WF_CONCLUIDA' %}<i class="fa-solid fa-check-double"></i>
                        {% elif evento.tipo_evento == 'ANDAMENTO' %}<i class="fa-solid fa-pencil"></i>
                        {% elif evento.tipo_evento == 'TIMESHEET' %}<i class="fa-solid fa-clock"></i>
                        {% elif evento.tipo_evento == 'ACORDO' %}<i class="fa-solid fa-handshake"></i>
                        {% elif evento.tipo_evento == 'DESPESA' %}<i class="fa-solid fa-dollar-sign"></i>
                        {% elif evento.tipo_evento == 'ANEXO' %}<i class="fa-solid fa-paperclip"></i>
                        {% else %}<i class="fa-solid fa-circle-info"></i>
                        {% endif %}
                    </div>

                    <!-- Conteúdo do Evento -->
                    <div class="timeline-content">
                        <h4>{{ evento.get_tipo_evento_display }}</h4>
                        <div class="fluxo-descricao">
                            {{ evento.descricao|linebreaksbr }}
                        </div>
                        <p class="fluxo-meta">
                            {% if evento.autor %}
                                por <strong>{{ evento.autor.get_full_name|default:evento.autor.username }}</strong>
                            {% else %}
                                por <strong>Sistema</strong>
                            {% endif %}
                            em {{ evento.data_evento|date:"d/m/Y H:i" }}
                        </p>
                    </div>
                </div>
            {% empty %}
                <div class="empty-state">
                    <p>Nenhum evento registrado no fluxo interno deste caso.</p>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Aba 5: Andamentos -->
    <div id="andamentos" class="tab-content">
        <div class="form-section"><h3>Registrar Novo Andamento</h3><form method="POST" action="{% url 'casos:detalhe_caso' pk=caso.pk %}">{% csrf_token %}<div class="form-group">{{ form_andamento.modelo_andamento.label_tag }}{{ form_andamento.modelo_andamento }}</div><div class="form-row"><div class="form-group">{{ form_andamento.data_andamento.label_tag }}{{ form_andamento.data_andamento }}</div></div><div class="form-group">{{ form_andamento.descricao.label_tag }}{{ form_andamento.descricao }}</div><button type="submit" name="submit_andamento" class="btn-submit andamento">Salvar Andamento</button></form></div>
        <hr>
        <div class="list-toolbar"><h3>Histórico de Andamentos</h3><div><a href="{% url 'casos:exportar_andamentos_excel' pk=caso.pk %}" class="btn-export">Exportar Excel</a></div></div>
        <div class="item-list">{% for andamento in andamentos %}<div class="item-card"><div class="item-card-header"><div class="item-card-header-info"><strong>Data: {{ andamento.data_andamento|date:"d/m/Y" }}</strong><small>por {% if andamento.autor %}{{ andamento.autor.get_full_name|default:andamento.autor.username }}{% else %}(usuário removido){% endif %} em {{ andamento.data_criacao|date:"d/m/Y H:i" }}</small></div></div><div class="andamento-body">{{ andamento.descricao|linebreaksbr }}</div></div>{% empty %}<div class="empty-state"><p>Nenhum andamento registrado.</p></div>{% endfor %}</div>
    </div>

    <!-- Aba 6: Timesheet -->
    <div id="timesheet" class="tab-content">
        <div class="form-section"><h3>Registrar Novo Lançamento</h3><form method="POST" action="{% url 'casos:detalhe_caso' pk=caso.pk %}">{% csrf_token %}<div class="form-row"><div class="form-group">{{ form_timesheet.data_execucao.label_tag }}{{ form_timesheet.data_execucao }}</div><div class="form-group">{{ form_timesheet.tempo.label_tag }}{{ form_timesheet.tempo }}</div></div><div class="form-group">{{ form_timesheet.advogado.label_tag }}{{ form_timesheet.advogado }}</div><div class="form-group">{{ form_timesheet.descricao.label_tag }}{{ form_timesheet.descricao }}</div><button type="submit" name="submit_timesheet" class="btn-submit timesheet">Salvar Lançamento</button></form></div>
        <div class="summary-box"><h3>Tempo Total Gasto</h3><p>{{ tempo_total|format_timedelta }}</p></div>
        <hr>
        <div class="list-toolbar"><h3>Histórico de Lançamentos</h3><div><a href="{% url 'casos:exportar_timesheet_excel' pk=caso.pk %}" class="btn-export">Exportar Excel</a><a href="{% url 'casos:exportar_timesheet_pdf' pk=caso.pk %}" class="btn-pdf">Exportar PDF</a></div></div>
        <table class="data-table"><thead><tr><th>Data</th><th>Tempo</th><th>Advogado</th><th>Descrição</th><th>Ações</th></tr></thead>
            <tbody>{% for ts in timesheets %}<tr><td>{{ ts.data_execucao|date:"d/m/Y" }}</td><td>{{ ts.tempo }}</td><td>{% if ts.advogado %}{{ ts.advogado.get_full_name|default:ts.advogado.username }}{% else %}-{% endif %}</td><td>{{ ts.descricao|linebreaksbr }}</td><td class="actions"><a href="{% url 'casos:editar_timesheet' pk=ts.pk %}" class="action-btn btn-edit">Editar</a><a href="{% url 'casos:deletar_timesheet' pk=ts.pk %}" class="action-btn btn-delete">Deletar</a></td></tr>{% empty %}<tr><td colspan="5" style="text-align: center; padding: 20px;">Nenhum lançamento de horas.</td></tr>{% endfor %}</tbody>
        </table>
    </div>
    
    <!-- Aba 7: Acordos -->
    <div id="acordos" class="tab-content">
        <div class="form-section"><h3>Registrar Novo Acordo</h3><form method="POST" action="{% url 'casos:detalhe_caso' pk=caso.pk %}">{% csrf_token %}<div class="form-row"><div class="form-group">{{ form_acordo.valor_total.label_tag }}{{ form_acordo.valor_total }}</div><div class="form-group">{{ form_acordo.numero_parcelas.label_tag }}{{ form_acordo.numero_parcelas }}</div></div><div class="form-row"><div class="form-group">{{ form_acordo.data_primeira_parcela.label_tag }}{{ form_acordo.data_primeira_parcela }}</div><div class="form-group">{{ form_acordo.advogado_acordo.label_tag }}{{ form_acordo.advogado_acordo }}</div></div><button type="submit" name="submit_acordo" class="btn-submit acordo">Salvar Acordo</button></form></div>
        <hr>
        <div class="summary-box"><h3>Saldo Devedor</h3><p>R$ {{ saldo_devedor_total|default:"0.00" }}</p></div>
        <div class="acordo-list">
            <div class="list-toolbar"><h3>Acordos Registrados</h3></div>
            <div class="item-list">{% for acordo in acordos %}<div class="item-card"><div class="item-card-header"><div class="item-card-header-info"><strong>Acordo de R$ {{ acordo.valor_total }} em {{ acordo.numero_parcelas }}x</strong><small>Criado em {{ acordo.data_criacao|date:"d/m/Y" }} por {% if acordo.advogado_acordo %}{{ acordo.advogado_acordo.get_full_name|default:acordo.advogado_acordo.username }}{% else %}-{% endif %}</small></div><a href="{% url 'casos:editar_acordo' pk=acordo.pk %}" class="action-btn btn-edit">Editar</a></div><div class="acordo-body"><table class="data-table"><thead><tr><th>Nº</th><th>Vencimento</th><th>Pagamento</th><th>Valor</th><th>Status</th></tr></thead><tbody>{% for parcela in acordo.parcelas.all %}{% include 'casos/partials/parcela_linha.html' with parcela=parcela %}{% endfor %}</tbody></table></div></div>{% empty %}<div class="empty-state"><p>Nenhum acordo registrado.</p></div>{% endfor %}</div>
        </div>
    </div>

        <!-- Aba 8: Despesas (VERSÃO CORRIGIDA E ORGANIZADA) -->
    <div id="despesas" class="tab-content">
        
        <!-- Formulário para Registrar Nova Despesa -->
        <div class="form-section">
            <h3>Registrar Nova Despesa</h3>
            <form method="POST" action="{% url 'casos:detalhe_caso' pk=caso.pk %}">
                {% csrf_token %}
                
                <div class="form-row">
                    <div class="form-group">
                        {{ form_despesa.data_despesa.label_tag }}
                        {{ form_despesa.data_despesa }}
                    </div>
                    <div class="form-group">
                        {{ form_despesa.valor.label_tag }}
                        {{ form_despesa.valor }}
                    </div>
                </div>
                
                <div class="form-group">
                    {{ form_despesa.descricao.label_tag }}
                    {{ form_despesa.descricao }}
                </div>
                
                <div class="form-group">
                    {{ form_despesa.advogado.label_tag }}
                    {{ form_despesa.advogado }}
                </div>
                
                <button type="submit" name="submit_despesa" class="btn-submit despesa">Salvar Despesa</button>
            </form>
        </div>
        
        <!-- Box de Resumo do Total de Despesas -->
        <div class="summary-box">
            <h3>Total de Despesas</h3>
            <p>{{ total_despesas|currency }}</p> {# Usando o filtro de moeda aqui também #}
        </div>
        
        <hr>
        
        <!-- Histórico de Despesas -->
        <div class="list-toolbar">
            <h3>Histórico de Despesas</h3>
            {# Adicione aqui botões de exportação, se desejar #}
        </div>
        
        <table class="data-table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Advogado</th>
                    <th>Descrição</th>
                    <th>Valor (R$)</th>
                    <th class="actions">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for despesa in despesas %}
                <tr>
                    <td>{{ despesa.data_despesa|date:"d/m/Y" }}</td>
                    <td>{% if despesa.advogado %}{{ despesa.advogado.get_full_name|default:despesa.advogado.username }}{% else %}-{% endif %}</td>
                    <td>{{ despesa.descricao }}</td>
                    
                    <!-- ============================================================================== -->
                    <!-- A CORREÇÃO DA FORMATAÇÃO DA MOEDA ESTÁ AQUI                                  -->
                    <!-- ============================================================================== -->
                    <td>{{ despesa.valor|currency }}</td>
                    
                    <td class="actions">
                        <a href="{% url 'casos:editar_despesa' pk=despesa.pk %}" class="action-btn btn-edit">Editar</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px;">Nenhuma despesa registrada.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Aba 9: Anexos-->
    <div id="anexos" class="tab-content">
        <h2>Anexos do Caso (SharePoint)</h2>
        {% if caso.sharepoint_folder_id %}
            <div class="anexos-container">
                <div id="file-list-panel">
                    <!-- O conteúdo (lista_arquivos.html) será incluído aqui -->
                    {% include 'casos/partials/lista_arquivos.html' %}
                </div>
                <div id="preview-panel">
                    <div class="preview-placeholder">
                        <i class="fa-solid fa-eye"></i>
                        <p>Clique em um arquivo para visualizá-lo aqui.</p>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="empty-state">
                <p>Nenhuma pasta foi criada no SharePoint para este caso.</p>
            </div>
        {% endif %}
    </div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('js-enabled');

    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    function activateTab(tabId) {
        tabButtons.forEach(button => { button.classList.toggle('active', button.dataset.tab === tabId); });
        tabContents.forEach(content => { content.classList.toggle('active', content.id === tabId); });
    }

    tabButtons.forEach(button => {
        button.addEventListener('click', () => { activateTab(button.dataset.tab); });
    });

    const urlParams = new URLSearchParams(window.location.search);
    const abaUrl = urlParams.get('aba');
    const abaInicial = (abaUrl && document.getElementById(abaUrl)) ? abaUrl : 'detalhes';
    activateTab(abaInicial);

    // --- Lógicas Específicas ---
    htmx.onLoad(function(content) {
        const selectModelo = content.querySelector('#andamentos select[name=modelo_andamento]');
        const textareaDescricao = content.querySelector('#andamentos textarea[name=descricao]');
        if (selectModelo && textareaDescricao) {
            const modelos = { {% for modelo in modelos_andamento %}"{{ modelo.id }}": "{{ modelo.descricao|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %} };
            selectModelo.addEventListener('change', function() { textareaDescricao.value = modelos[this.value] || ''; });
        }

        const tempoInput = content.querySelector('input[name="tempo"]');
        if (tempoInput) {
            tempoInput.addEventListener('input', function (e) {
                let value = e.target.value.replace(/\D/g, '');
                e.target.value = (value.length > 2 ? value.substring(0, 2) + ':' + value.substring(2, 4) : value).substring(0, 5);
            });
        }
    });

    // Eventos HTMX
    document.body.addEventListener('htmx:xhr:progress', function(event) {
        const panel = document.getElementById('file-list-panel');
        if (!panel) return;
        const progressBar = panel.querySelector('progress');
        const progressText = panel.querySelector('progress + span');
        if (progressBar && progressText) {
            let percent = Math.round((event.detail.loaded / event.detail.total) * 100);
            progressBar.value = percent;
            progressText.innerText = `${percent}%`;
        }
    });

    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'file-list-panel') {
            const fileListPreview = document.getElementById('file-list-panel').querySelector('.file-list-preview');
            if (fileListPreview) fileListPreview.textContent = '';
        }
    });
});
// Função global para o onchange do input de arquivo
function updateFileList(input) {
    const parentForm = input.closest('form');
    if (!parentForm) return;
    const fileListPreview = parentForm.querySelector('.file-list-preview');
    if (fileListPreview && input.files.length > 0) {
        let fileNames = Array.from(input.files).map(file => file.name).join(', ');
        fileListPreview.textContent = fileNames.length > 100 ? `${input.files.length} arquivos selecionados.` : `Selecionado(s): ${fileNames}`;
    } else if (fileListPreview) {
        fileListPreview.textContent = '';
    }
}
</script>
{% endblock %}
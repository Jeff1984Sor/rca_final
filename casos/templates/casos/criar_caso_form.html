{% extends "base.html" %}
{% load static custom_tags %}

{% block title %}Criar Novo Caso{% endblock %}

{% block extra_css %}
    <!-- GARANTIA DE ESTILOS (CDNs) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <style>
        /* --- 1. FUNDO DA PÁGINA --- */
        body { background-color: #fd7e14 !important; min-height: 100vh; }

        /* --- 2. CABEÇALHO --- */
        .hero-header { background-color: #fd7e14; color: #212529; padding-top: 20px; padding-bottom: 20px; }
        .hero-header h2, .hero-header i { color: #000000 !important; font-weight: 800; }
        .hero-header .badge { background-color: rgba(255, 255, 255, 0.6) !important; color: #000000 !important; font-size: 0.9rem; }
        
        /* --- 3. CARTÃO DO FORMULÁRIO --- */
        .form-card { background-color: #ffffff !important; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); padding: 40px; margin-bottom: 50px; }

        /* --- 4. TÍTULOS INTERNOS --- */
        h3.section-title { font-size: 1.1rem; font-weight: 700; color: #fd7e14; border-bottom: 2px solid #fff3cd; padding-bottom: 10px; margin-bottom: 20px; margin-top: 30px; }

        /* --- 5. BOTÕES --- */
        .btn-orange { background-color: #fd7e14 !important; border-color: #fd7e14 !important; color: white !important; font-weight: bold; }
        .btn-orange:hover { background-color: #e36902 !important; }
        .btn-add-item { color: #fd7e14; border: 1px dashed #fd7e14; background: transparent; font-weight: 600; transition: all 0.3s; }
        .btn-add-item:hover { background-color: #fff3cd; color: #e36902; }

        .select2-container { width: 100% !important; }
        textarea.form-control { min-height: 100px; } /* Ajuste para Texto Longo */
    </style>
{% endblock %}

{% block content %}
<div class="container pb-5">

    <div class="hero-header d-flex justify-content-between align-items-center mt-2 mb-3">
        <div>
            <h2 class="mb-0"><i class="fa-solid fa-folder-plus"></i> Criar Novo Caso</h2>
            <div class="mt-2">
                <span class="badge">{{ cliente.nome }}</span>
                <i class="fa-solid fa-chevron-right mx-1 small"></i>
                <span class="badge">{{ produto.nome }}</span>
            </div>
        </div>
    </div>
    
    {% include 'casos/partials/app_messages.html' %}
    
    <div class="form-card">
        <form method="post" id="formCaso" novalidate>
            {% csrf_token %}

            <!-- 1. DADOS PRINCIPAIS -->
            <h3 class="section-title"><i class="fa-solid fa-info-circle"></i> Dados Principais</h3>
            <div class="row g-3">
                {% for field in form.campos_fixos %}
                    {% if field.name != 'tomador' and field.name != 'segurado' and field.name != 'titulo_manual' %}
                        <div class="col-md-6">
                            <label class="form-label fw-bold">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}<div class="text-danger small">{{ field.errors.0 }}</div>{% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            
            <!-- 2. DADOS ADICIONAIS -->
            <h3 class="section-title"><i class="fa-solid fa-list-check"></i> Dados Adicionais</h3>
            <div class="row g-3">
                {% for field in form.campos_personalizados_simples %}
                    <!-- Se for Textarea (Texto Longo), ocupa col-12, senão col-md-6 -->
                    <div class="{% if 'textarea' in field.field.widget.attrs.class %}col-12{% else %}col-md-6{% endif %}">
                        <label class="form-label fw-bold">{{ field.label }}</label>
                        {{ field }}
                    </div>
                {% endfor %}
            </div>

            <!-- 3. SEGURADO -->
            {% if 'segurado' in form.fields %}
            <h3 class="section-title"><i class="fa-solid fa-user-shield"></i> Segurado</h3>
            <div class="p-3 bg-light rounded border">
                <div class="row">
                    <div class="col-12 mb-2">
                        <label class="form-label fw-bold">Selecione o Segurado:</label>
                        {{ form.segurado }}
                    </div>

                    <div class="col-12 mb-2" id="painelDetalhesSegurado" style="display:none;">
                        <div class="card card-body bg-white border shadow-sm py-2">
                            <div class="row text-muted small">
                                <div class="col-md-4"><strong>CPF/CNPJ:</strong> <span id="lblSeguradoDoc">-</span></div>
                                <div class="col-md-4"><strong>Emails:</strong> <span id="lblSeguradoEmails">-</span></div>
                                <div class="col-md-4"><strong>Fones:</strong> <span id="lblSeguradoFones">-</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 mt-2">
                        <a href="{% url 'casos:criar_segurado' %}" class="btn btn-sm btn-orange">
                            <i class="fa-solid fa-plus"></i> Cadastrar Novo Segurado
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 3. TOMADOR -->
            {% if 'tomador' in form.fields %}
            <h3 class="section-title"><i class="fa-solid fa-user-tie"></i> Tomador</h3>
            <div class="p-3 bg-light rounded border">
                <div class="row">
                    <div class="col-12 mb-2">
                        <label class="form-label fw-bold">Selecione o Tomador:</label>
                        {{ form.tomador }}
                    </div>
                    
                    <div class="col-12 mb-2" id="painelDetalhes" style="display:none;">
                        <div class="card card-body bg-white border shadow-sm py-2">
                            <div class="row text-muted small">
                                <div class="col-md-4"><strong>CPF/CNPJ:</strong> <span id="lblCpf">-</span></div>
                                <div class="col-md-4"><strong>Emails:</strong> <span id="lblEmails">-</span></div>
                                <div class="col-md-4"><strong>Fones:</strong> <span id="lblFones">-</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 mt-2">
                        <button type="button" class="btn btn-sm btn-orange" data-bs-toggle="modal" data-bs-target="#modalNovoTomador">
                            <i class="fa-solid fa-plus"></i> Cadastrar Novo Tomador
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- 4. GRUPOS REPETÍVEIS -->
            {% if grupo_formsets %}
                {% for grupo, formset in grupo_formsets %}
                    <h3 class="section-title"><i class="fa-solid fa-layer-group"></i> {{ grupo.nome_grupo }}</h3>
                    {{ formset.management_form }}
                    <div id="formset-container-{{ grupo.id }}">
                        {% for form_grupo in formset %}
                            <div class="card mb-3 border-light bg-light grupo-form">
                                <div class="card-body">
                                    <div class="row g-3">
                                        {% for field in form_grupo.visible_fields %}
                                            {% if field.name == 'DELETE' %}
                                                <div class="col-md-6 d-flex align-items-end">
                                                    <div class="d-none">{{ field }}</div>
                                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFormsetRow(this)">
                                                        <i class="fa-solid fa-trash"></i> Remover
                                                    </button>
                                                </div>
                                            {% else %}
                                                <div class="{% if 'textarea' in field.field.widget.attrs.class %}col-12{% else %}col-md-6{% endif %}">
                                                    <label class="form-label small fw-bold">{{ field.label }}</label>
                                                    {{ field }}
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                        {% for hidden in form_grupo.hidden_fields %}{{ hidden }}{% endfor %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <button type="button" class="btn btn-sm btn-add-item mb-4" onclick="addFormsetRow('{{ grupo.id }}', '{{ formset.prefix }}')">
                        <i class="fa-solid fa-plus-circle"></i> Incluir novo em {{ grupo.nome_grupo }}
                    </button>

                    <!-- Template Vazio (Escondido) -->
                    <div id="empty-form-{{ grupo.id }}" style="display:none;">
                        <div class="card mb-3 border-light bg-light shadow-sm grupo-form">
                            <div class="card-body">
                                <div class="row g-3">
                                    {% for field in formset.empty_form.visible_fields %}
                                        {% if field.name == 'DELETE' %}
                                            <div class="col-md-6 d-flex align-items-end">
                                                <div class="d-none">{{ field }}</div>
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeFormsetRow(this)">
                                                    <i class="fa-solid fa-trash"></i> Remover
                                                </button>
                                            </div>
                                        {% else %}
                                            <div class="{% if 'textarea' in field.field.widget.attrs.class %}col-12{% else %}col-md-6{% endif %}">
                                                <label class="form-label small fw-bold">{{ field.label }}</label>
                                                {{ field }}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% endif %}

            <div class="d-flex justify-content-end gap-2 mt-5 pt-3 border-top">
                <a href="{% url 'casos:selecionar_produto_cliente' %}" class="btn btn-secondary px-4">Cancelar</a>
                <button type="submit" class="btn btn-orange px-4">Criar Caso</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL NOVO TOMADOR -->
<div class="modal fade" id="modalNovoTomador" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-orange text-white" style="background-color: #fd7e14;">
                <h5 class="modal-title">Novo Tomador</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formTomadorAjax">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Nome *</label>
                        <input type="text" name="nome" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tipo</label>
                        <select name="tipo" class="form-select">
                            <option value="PF" selected>Pessoa Fisica</option>
                            <option value="PJ">Pessoa Juridica</option>
                        </select>
                    </div>
                    <div class="mb-3" id="cpfField">
                        <label class="form-label">CPF</label>
                        <input type="text" name="cpf" class="form-control custom-mask" data-mask="000.000.000-00">
                    </div>
                    <div class="mb-3" id="cnpjField" style="display:none;">
                        <label class="form-label">CNPJ</label>
                        <input type="text" name="cnpj" class="form-control custom-mask" data-mask="00.000.000/0000-00">
                    </div>
                    <hr>
                    <div class="mb-2">
                        <label class="form-label">E-mails</label>
                        <div id="divEmails">
                            <input type="email" name="lista_emails" class="form-control mb-2" placeholder="Email principal">
                        </div>
                        <button type="button" class="btn btn-sm btn-light border" onclick="addEmail()">+ Outro</button>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Telefones</label>
                        <div id="divFones">
                            <input type="text" name="lista_telefones" class="form-control mb-2" placeholder="Telefone principal">
                        </div>
                        <button type="button" class="btn btn-sm btn-light border" onclick="addFone()">+ Outro</button>
                    </div>
                    <div id="msgErro" class="alert alert-danger d-none mt-3"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-orange" onclick="salvarTomador()">Salvar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<script>
    // --- FUNÇÕES DE MÁSCARA ---
    function aplicarMascaras() {
        // Moeda: O '#' permite números infinitos antes da vírgula (corrige o bug de 2 dígitos)
        $('.money').mask('R$ 000.000.000.000.000,00', {reverse: true});

        // Máscaras Dinâmicas do Admin (data-mask)
        $('.custom-mask').each(function() {
            var m = $(this).attr('data-mask');
            if(m) $(this).mask(m);
        });
    }

    function addFormsetRow(grupoId, prefix) {
        const totalFormsInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
        const currentCount = parseInt(totalFormsInput.value);
        const templateHtml = document.getElementById(`empty-form-${grupoId}`).innerHTML;
        const newRowHtml = templateHtml.replace(/__prefix__/g, currentCount);

        const container = document.getElementById(`formset-container-${grupoId}`);
        const wrapper = document.createElement('div');
        wrapper.innerHTML = newRowHtml;
        container.appendChild(wrapper.firstElementChild);

        totalFormsInput.value = currentCount + 1;
        aplicarMascaras(); // Reaplica máscaras na linha nova
    }

    function removeFormsetRow(button) {
        const formCard = button.closest('.grupo-form');
        if (!formCard) return;
        const deleteInput = formCard.querySelector('input[name$="-DELETE"]');
        if (deleteInput) deleteInput.checked = true;
        formCard.style.display = 'none';
    }

    $(document).ready(function() {
        aplicarMascaras();

        $('.select2-segurado').select2({ theme: 'bootstrap-5', width: '100%', placeholder: 'Pesquise...', allowClear: true });

        $('.select2-tomador').select2({ theme: 'bootstrap-5', width: '100%', placeholder: 'Pesquise...', allowClear: true });

        const toggleDocumentoFields = (tipo) => {
            if (tipo === 'PJ') {
                $('#cpfField').hide();
                $('#cnpjField').show();
            } else {
                $('#cnpjField').hide();
                $('#cpfField').show();
            }
        };

        toggleDocumentoFields($('select[name="tipo"]').val());
        $('select[name="tipo"]').on('change', function() {
            toggleDocumentoFields($(this).val());
            aplicarMascaras();
        });

        $('.select2-segurado').on('change', function() {
            var id = $(this).val();
            if (id) {
                $.get('/casos/ajax/segurado/' + id + '/detalhes/', function(data) {
                    if (data.success) {
                        $('#lblSeguradoDoc').text(data.documento || '-');
                        $('#lblSeguradoEmails').text(data.emails.join(', ') || '-');
                        $('#lblSeguradoFones').text(data.telefones.join(', ') || '-');
                        $('#painelDetalhesSegurado').slideDown();
                    }
                });
            } else {
                $('#painelDetalhesSegurado').slideUp();
            }
        });

        $('.select2-tomador').on('change', function() {
            var id = $(this).val();
            if(id) {
                $.get('/casos/ajax/tomador/' + id + '/detalhes/', function(data) {
                    if(data.success) {
                        $('#lblCpf').text(data.documento || '-');
                        $('#lblEmails').text(data.emails.join(', ') || '-');
                        $('#lblFones').text(data.telefones.join(', ') || '-');
                        $('#painelDetalhes').slideDown();
                    }
                });
            } else { $('#painelDetalhes').slideUp(); }
        });
    });

    function addEmail() { $('#divEmails').append('<input type="email" name="lista_emails" class="form-control mb-2" placeholder="Outro Email">'); }
    function addFone() { $('#divFones').append('<input type="text" name="lista_telefones" class="form-control mb-2" placeholder="Outro Telefone">'); }

    function salvarTomador() {
        $.ajax({
            url: "{% url 'casos:ajax_criar_tomador' %}",
            type: "POST",
            data: $('#formTomadorAjax').serialize(),
            success: function(resp) {
                if(resp.success) {
                    var newOption = new Option(resp.text, resp.id, true, true);
                    $('.select2-tomador').append(newOption).trigger('change');
                    bootstrap.Modal.getInstance(document.getElementById('modalNovoTomador')).hide();
                    $('#formTomadorAjax')[0].reset();
                } else { $('#msgErro').text('Erro: ' + JSON.stringify(resp.errors)).removeClass('d-none'); }
            }
        });
    }
</script>
{% endblock %}

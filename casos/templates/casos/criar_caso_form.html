{% extends "base.html" %}
{% load static custom_tags %}

{% block title %}Criar Novo Caso | {{ cliente.nome }} - {{ produto.nome }}{% endblock %}

{% block content %}

    
    <!-- HERO HEADER -->
    <div class="hero-header">
        <h1 class="hero-title"><i class="fa-solid fa-folder-plus"></i> Criar Novo Caso</h1>
        <div class="hero-subtitle">
            <span class="badge bg-dark"><i class="fa-solid fa-building"></i> {{ cliente.nome }}</span>
            <span class="text-muted">/</span>
            <span class="badge bg-dark"><i class="fa-solid fa-box"></i> {{ produto.nome }}</span>
        </div>
    </div>
    
    {% include 'casos/partials/app_messages.html' %}
    
    <!-- FORM CARD -->
    <div class="form-card">
        <form method="post" action="" class="needs-validation" novalidate>
            {% csrf_token %}
            <div class="card-content" style="padding: 40px;">
                <!-- DADOS PRINCIPAIS -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fa-solid fa-circle-info"></i> Dados Principais</h3>
                    <div class="fields-grid">
                        {% for field in form.campos_fixos %}{% include "_form_field.html" with field=field icon="tag" %}{% endfor %}
                    </div>
                </div>
                
                <!-- DADOS ADICIONAIS -->
                <div class="form-section">
                    <h3 class="form-section-title"><i class="fa-solid fa-sliders"></i> Dados Adicionais</h3>
                    <div class="fields-grid">
                        {% for field in form.campos_personalizados_simples %}
                            {% include "_form_field.html" with field=field icon="circle-dot" %}
                        {% endfor %}
                    </div>
                </div>
                
                <!-- GRUPOS REPETÃVEIS -->
                {% if grupo_formsets %}{% for grupo, formset in grupo_formsets %}
                <div class="grupo-repetiveis-section">
                    <div class="grupo-header">
                        <h3 class="grupo-title"><i class="fa-solid fa-layer-group"></i> {{ grupo.nome_grupo }}</h3>
                        <button type="button" class="btn btn-success add-grupo-btn" data-formset-prefix="{{ formset.prefix }}" data-grupo-id="{{ grupo.id }}"><i class="fa-solid fa-plus-circle"></i> Adicionar Item</button>
                    </div>
                    {{ formset.management_form }}
                    <div id="formset-container-{{ grupo.id }}">
                        {% for form_grupo in formset %}<div class="grupo-item grupo-form">
                            {% if formset.can_delete %}<div style="display: none;">{{ form_grupo.DELETE }}</div>{% endif %}
                            <div class="grupo-item-header">
                                <div class="grupo-item-number"><i class="fa-solid fa-hashtag"></i> Item {{ forloop.counter }}</div>
                                <button type="button" class="btn btn-sm btn-danger delete-grupo-btn"><i class="fa-solid fa-trash-alt"></i> Remover</button>
                            </div>
                            <div class="fields-grid">
                                {% for field in form_grupo.visible_fields %}{% include "_form_field.html" with field=field icon="circle-dot" %}{% endfor %}
                            </div>
                        </div>{% endfor %}
                    </div>
                    <div id="empty-form-{{ grupo.id }}" style="display:none;"><div class="grupo-item grupo-form">
                        {% if formset.can_delete %}<div style="display: none;">{{ formset.empty_form.DELETE }}</div>{% endif %}
                        <div class="grupo-item-header">
                            <div class="grupo-item-number"><i class="fa-solid fa-hashtag"></i> Novo Item</div>
                            <button type="button" class="btn btn-sm btn-danger delete-grupo-btn"><i class="fa-solid fa-trash-alt"></i> Remover</button>
                        </div>
                        <div class="fields-grid">
                            {% for field in formset.empty_form.visible_fields %}{% include "_form_field.html" with field=field icon="circle-dot" %}{% endfor %}
                        </div>
                    </div></div>
                </div>
                {% endfor %}{% endif %}
            </div>
            
            <!-- FOOTER ACTIONS -->
            <div class="form-footer">
                <a href="{% url 'casos:selecionar_produto_cliente' %}" class="btn btn-outline-secondary"><i class="fa-solid fa-times-circle"></i> Cancelar</a>
                <button type="submit" class="btn btn-primary"><i class="fa-solid fa-save"></i> Criar Caso</button>
            </div>
        </form>
    </div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/form_criar_caso.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initCriarCasoForm({
            cancelUrl: "{% url 'casos:selecionar_produto_cliente' %}"
        });
    });
</script>
{% endblock %}
{% extends 'base.html' %}

{% block title %}Gestão de Casos{% endblock %}

{% block content %}
    <h1 style="font-size: 2.25rem; font-weight: 700; margin-bottom: 24px;">Gestão de Casos</h1>

    <!-- Card de Filtros -->
    <div class="card">
        <form method="GET" action="{% url 'casos:lista_casos' %}">
            <div class="form-row" style="align-items: flex-end;">
                <div class="form-group">
                    <label for="id_filtro_titulo">Título</label>
                    <input id="id_filtro_titulo" type="text" name="filtro_titulo" placeholder="Filtrar por título..." value="{{ valores_filtro.filtro_titulo }}">
                </div>
                <div class="form-group">
                    <label for="id_filtro_cliente">Cliente</label>
                    <select id="id_filtro_cliente" name="filtro_cliente">
                        <option value="">Todos</option>
                        {% for cliente in todos_clientes %}<option value="{{ cliente.id }}" {% if valores_filtro.filtro_cliente == cliente.id|stringformat:"s" %}selected{% endif %}>{{ cliente.nome }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="id_filtro_produto">Produto</label>
                    <select id="id_filtro_produto" name="filtro_produto">
                        <option value="">Todos</option>
                        {% for produto in todos_produtos %}<option value="{{ produto.id }}" {% if valores_filtro.filtro_produto == produto.id|stringformat:"s" %}selected{% endif %}>{{ produto.nome }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="id_filtro_status">Status</label>
                    <select id="id_filtro_status" name="filtro_status">
                        <option value="">Todos</option>
                        {% for value, display in status_choices %}<option value="{{ value }}" {% if valores_filtro.filtro_status == value %}selected{% endif %}>{{ display }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="id_filtro_advogado">Advogado</label>
                    <select id="id_filtro_advogado" name="filtro_advogado">
                        <option value="">Todos</option>
                        {% for advogado in todos_advogados %}<option value="{{ advogado.id }}" {% if valores_filtro.filtro_advogado == advogado.id|stringformat:"s" %}selected{% endif %}>{{ advogado.get_full_name|default:advogado.username }}</option>{% endfor %}
                    </select>
                </div>
                <!-- Botões de Ação do Filtro -->
                <div class="form-group">
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-success">Filtrar</button>
                        <a href="{% url 'casos:lista_casos' %}" class="btn btn-secondary">Limpar</a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Barra de Ações (Exportar, Novo) -->
    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 24px;">
        <a href="{% url 'casos:exportar_excel' %}?{{ request.GET.urlencode }}" class="btn btn-info">Exportar Excel</a>
        <a href="{% url 'casos:selecionar_produto_cliente' %}" class="btn btn-primary">Abrir Novo Caso</a>
    </div>

    <!-- Card da Tabela -->
    <div class="data-table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Título</th>
                    <th>Cliente</th>
                    <th>Produto</th>
                    <th>Status</th>
                    <th>Data de Entrada</th>
                    <th>Responsável</th>
                    <th style="text-align: right;">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for caso in casos %}
                <tr>
                    <td>{{ caso.id|stringformat:"05d" }}</td>
                    <td>{{ caso.titulo|default:"(sem título)"|truncatechars:40 }}</td>
                    <td>{{ caso.cliente.nome }}</td>
                    <td>{{ caso.produto.nome }}</td>
                    <td>{{ caso.get_status_display }}</td>
                    <td>{{ caso.data_entrada|date:"d/m/Y" }}</td>
                    <td>{% if caso.advogado_responsavel %}{{ caso.advogado_responsavel.get_full_name|default:caso.advogado_responsavel.username }}{% else %}-{% endif %}</td>
                    <td class="actions">
                        <a href="{% url 'casos:detalhe_caso' pk=caso.pk %}" class="action-btn btn-info">Ver Detalhes</a>
                        <a href="{% url 'casos:editar_caso' pk=caso.pk %}" class="action-btn btn-edit">Editar</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8">
                        <div class="empty-state">
                            <p>Nenhum caso encontrado com os filtros aplicados.</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}
{% extends "base.html" %}
{% load static %}
{% load custom_tags %}

{% block title %}Gestão de Casos | Sistema Jurídico{% endblock %}

{% block content %}

    
    <!-- HERO HEADER -->
    <div class="hero-header">
        <div class="hero-content">
            <h1 class="hero-title"><i class="fa-solid fa-folder-open"></i> Gestão de Casos</h1>
            <div class="hero-actions d-flex gap-12">
                <a href="{% url 'casos:exportar_excel' %}?{{ request.GET.urlencode }}" class="btn btn-export"><i class="fa-solid fa-file-excel"></i> Exportar</a>
                <a href="{% url 'casos:selecionar_produto_cliente' %}" class="btn btn-success"><i class="fa-solid fa-plus-circle"></i> Novo Caso</a>
            </div>
        </div>
    </div>
    
    <!-- MENSAGENS -->
    {% include 'casos/partials/app_messages.html' %}
    
    <!-- FILTROS -->
    <div class="card filtros-card">
        <div class="card-header filtros-header">
            <h5><i class="fa-solid fa-filter"></i> Filtros de Pesquisa</h5>
        </div>
        <div class="card-body">
            <form action="{% url 'casos:lista_casos' %}" method="get">
                <div class="form-row">
                    <div class="form-group"><label for="filtro_titulo"><i class="fa-solid fa-heading"></i> Título</label><input type="text" class="form-control" id="filtro_titulo" name="filtro_titulo" value="{{ valores_filtro.filtro_titulo }}" placeholder="Buscar por título..."></div>
                    <div class="form-group"><label for="filtro_cliente"><i class="fa-solid fa-building"></i> Cliente</label><select class="form-control" id="filtro_cliente" name="filtro_cliente"><option value="">Todos</option>{% for cliente in todos_clientes %}<option value="{{ cliente.id }}" {% if valores_filtro.filtro_cliente == cliente.id|stringformat:"s" %}selected{% endif %}>{{ cliente.nome }}</option>{% endfor %}</select></div>
                    <div class="form-group"><label for="filtro_produto"><i class="fa-solid fa-box"></i> Produto</label><select class="form-control" id="filtro_produto" name="filtro_produto"><option value="">Todos</option>{% for produto in todos_produtos %}<option value="{{ produto.id }}" {% if valores_filtro.filtro_produto == produto.id|stringformat:"s" %}selected{% endif %}>{{ produto.nome }}</option>{% endfor %}</select></div>
                    <div class="form-group"><label for="filtro_status"><i class="fa-solid fa-flag"></i> Status</label><select class="form-control" id="filtro_status" name="filtro_status"><option value="">Todos</option>{% for key, display in status_choices %}<option value="{{ key }}" {% if valores_filtro.filtro_status == key %}selected{% endif %}>{{ display }}</option>{% endfor %}</select></div>
                    <div class="form-group"><label for="filtro_advogado"><i class="fa-solid fa-user-tie"></i> Advogado</label><select class="form-control" id="filtro_advogado" name="filtro_advogado"><option value="">Todos</option>{% for advogado in todos_advogados %}<option value="{{ advogado.id }}" {% if valores_filtro.filtro_advogado == advogado.id|stringformat:"s" %}selected{% endif %}>{{ advogado.get_full_name|default:advogado.username }}</option>{% endfor %}</select></div>
                </div>
                <div class="form-actions d-flex justify-content-start">
                    <button type="submit" class="btn btn-filter"><i class="fa-solid fa-magnifying-glass"></i> Filtrar Casos</button>
                    <a href="{% url 'casos:lista_casos' %}" class="btn btn-clear"><i class="fa-solid fa-eraser"></i> Limpar Filtros</a>
                </div>
            </form>
        </div>
    </div>
    
    <!-- TABELA -->
    <div class="data-table-container mt-4">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Título</th>
                    <th>Cliente</th>
                    <th>Produto</th>
                    <th>Status</th>
                    <th>Data Entrada</th>
                    <th>Responsável</th>
                    <th class="text-right">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for caso in casos %}
                <tr onclick="window.location='{{ caso.get_absolute_url }}';" style="cursor: pointer;">
                    <td><strong>#{{ caso.id|stringformat:"05d" }}</strong></td>
                    <td>{{ caso.titulo|truncatechars:50 }}</td>
                    <td>{{ caso.cliente.nome }}</td>
                    <td>{{ caso.produto.nome }}</td>
                    <td>
                        <span class="badge {% if caso.status == 'ATIVO' %}bg-success{% elif caso.status == 'ENCERRADO' %}bg-secondary{% elif caso.status == 'SUSPENSO' %}bg-warning{% else %}bg-info{% endif %}">{{ caso.get_status_display }}</span>
                    </td>
                    <td>{{ caso.data_entrada|date:"d/m/Y" }}</td>
                    <td>{{ caso.advogado_responsavel.first_name|default:"-" }}</td>
                    <td class="text-right" onclick="event.stopPropagation();">
                        <a href="{{ caso.get_absolute_url }}" class="btn action-btn btn-info" title="Ver detalhes"><i class="fa-solid fa-eye"></i></a>
                        <a href="{% url 'casos:editar_caso' pk=caso.pk %}" class="btn action-btn btn-edit" title="Editar caso"><i class="fa-solid fa-pen-to-square"></i></a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="8"><div class="empty-state"><i class="fa-solid fa-folder-open"></i><h3>Nenhum caso encontrado</h3><p>Tente ajustar os filtros ou criar um novo caso.</p></div></td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initListaCasos({
            createUrl: "{% url 'casos:selecionar_produto_cliente' %}",
            listUrl: "{% url 'casos:lista_casos' %}"
        });
    });
</script>
{% endblock %}

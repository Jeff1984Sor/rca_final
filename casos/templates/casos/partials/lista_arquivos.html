{% load file_icons %}

<!-- Barra de Ferramentas com Navegação e Formulário de Nova Pasta -->
<div class="file-browser-toolbar">
    <span class="folder-nav">
        {% if root_folder_id and root_folder_id != folder_id %}
            <a href="#" class="back-button"
               hx-get="{% url 'casos:carregar_conteudo_pasta' folder_id=root_folder_id %}?root_folder_id={{ root_folder_id }}"
               hx-target="#file-list-panel"
               hx-swap="innerHTML"
               hx-indicator="#file-list-panel"
               title="Voltar para a pasta raiz do caso">
               <i class="fa-solid fa-arrow-left"></i>
            </a>
        {% endif %}
        Pasta Atual: <strong>{{ folder_name|default:"Raiz" }}</strong>
    </span>

    <form class="new-folder-form"
          hx-post="{% url 'casos:criar_pasta' parent_folder_id=folder_id %}"
          hx-target="#file-list-panel"
          hx-swap="innerHTML"
          hx-indicator="this">
        {% csrf_token %}
        <input type="hidden" name="root_folder_id" value="{{ root_folder_id }}">
        <input type="text" name="nome_pasta" placeholder="Nome da nova pasta..." required>
        <button type="submit" class="btn-new-folder" title="Criar Nova Pasta">
            <i class="fa-solid fa-folder-plus"></i> Criar
        </button>
    </form>
</div>

<!-- Formulário de Upload Moderno -->
<div class="upload-form-container">
    <form hx-post="{% url 'casos:upload_arquivo' folder_id=folder_id %}"
          hx-encoding="multipart/form-data"
          hx-target="#file-list-panel"
          hx-swap="innerHTML"
          hx-indicator=".upload-indicator-{{ folder_id }}">
        {% csrf_token %}
        <input type="hidden" name="root_folder_id" value="{{ root_folder_id }}">
        
        <label for="file-upload-{{ folder_id }}" class="upload-label">
            <i class="fa-solid fa-cloud-arrow-up"></i> Escolher Arquivos
        </label>
        <input id="file-upload-{{ folder_id }}" type="file" name="arquivos" multiple required onchange="updateFileList(this, '{{ folder_id }}')">
        
        <button type="submit" class="btn-upload">Enviar Anexos</button>
        
        <span class="upload-indicator-{{ folder_id }} htmx-indicator">
            <i class="fa-solid fa-spinner fa-spin"></i> Enviando...
        </span>
        
        <div id="file-list-preview-{{ folder_id }}" class="file-list-preview"></div>

        <div id="progress-container-{{ folder_id }}" class="upload-indicator-{{ folder_id }} htmx-indicator progress-container">
            <progress id="progress-bar-{{ folder_id }}" value="0" max="100"></progress>
            <span id="progress-text-{{ folder_id }}">0%</span>
        </div>
    </form>
</div>

<hr style="margin: 20px 0;">

<!-- Grid de Arquivos e Pastas -->
<div class="file-grid">
{% for item in itens %}
    <div class="grid-item">
        <!-- BOTÃO DE EXCLUIR -->
        <button class="delete-btn"
                hx-post="{% url 'casos:excluir_anexo' item_id=item.id %}"
                hx-target="#file-list-panel"
                hx-swap="innerHTML"
                hx-confirm="Você tem certeza que deseja excluir '{{ item.name }}' permanentemente?"
                hx-include="[name='root_folder_id_{{ folder_id }}'], [name='parent_folder_id_{{ folder_id }}']">
            <i class="fa-solid fa-trash-can"></i>
        </button>

        <!-- Hidden inputs com IDs únicos para a exclusão -->
        <input type="hidden" name="root_folder_id_{{ folder_id }}" value="{{ root_folder_id }}">
        <input type="hidden" name="parent_folder_id_{{ folder_id }}" value="{{ folder_id }}">

        <div class="grid-item-link"
             {% if item.folder %}
                hx-get="{% url 'casos:carregar_conteudo_pasta' folder_id=item.id %}?root_folder_id={{ root_folder_id }}"
                hx-target="#file-list-panel"
                hx-swap="innerHTML"
                hx-indicator="#file-list-panel"
                title="Abrir pasta: {{ item.name }}"
                style="cursor: pointer;"
             {% else %}
                hx-get="{% url 'casos:preview_anexo' item_id=item.id %}"
                hx-target="#preview-panel"
                hx-swap="innerHTML"
                hx-indicator="#preview-panel"
                title="Visualizar arquivo: {{ item.name }}"
                style="cursor: pointer;"
             {% endif %}>
            
            <div class="icon-container">
                {% if item.folder %}
                    <i class="fa-solid fa-folder"></i>
                {% else %}
                    <i class="{{ item.name|get_file_icon }}"></i>
                {% endif %}
            </div>

            <span class="item-name" title="{{ item.name }}">
                {{ item.name }}
            </span>
        </div>
    </div>
{% empty %}
    <p style="grid-column: 1 / -1; text-align: center;">Esta pasta está vazia. Você pode criar subpastas ou enviar arquivos usando os formulários acima.</p>
{% endfor %}
</div>

<!-- Scripts (permanecem os mesmos) -->
<script>
    function updateFileList(input, folderId) { /* ... */ }
    htmx.on('#file-list-panel', 'htmx:xhr:progress', function(event) { /* ... */ });
    htmx.on('#file-list-panel', 'htmx:afterSwap', function(event){ /* ... */ });
</script>
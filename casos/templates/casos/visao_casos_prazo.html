{% extends 'base.html' %}
{% load custom_tags %}

{% block title %}Visão dos Casos por Prazo{% endblock %}

{% block extra_css %}
<style>
    .prazo-vencido { color: #dc3545; font-weight: bold; }
    .prazo-urgente { color: #fd7e14; font-weight: bold; }
    .prazo-atencao { color: #ffc107; }
</style>
{% endblock %}


{% block content %}
<div class="container-fluid mt-4">
    <div class="card shadow-sm border-0">
        <div class="card-header bg-light">
            <h4 class="mb-0">Visão dos Casos por Prazo</h4>
        </div>
        <div class="card-body">
            <!-- Formulário de Filtros -->
            <form method="get" action="" class="mb-4 p-3 border rounded bg-light">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="prazo_inicio" class="form-label">Prazo Final (De)</label>
                        <input type="date" name="prazo_inicio" id="prazo_inicio" class="form-control" value="{{ valores_filtro.prazo_inicio }}">
                    </div>
                    <div class="col-md-3">
                        <label for="prazo_fim" class="form-label">Prazo Final (Até)</label>
                        <input type="date" name="prazo_fim" id="prazo_fim" class="form-control" value="{{ valores_filtro.prazo_fim }}">
                    </div>
                    <div class="col-md-2">
                        <label for="filtro_cliente" class="form-label">Cliente</label>
                        <select name="filtro_cliente" id="filtro_cliente" class="form-select">
                            <option value="">Todos</option>
                            {% for cliente in todos_clientes %}
                                <option value="{{ cliente.id }}" {% if valores_filtro.filtro_cliente == cliente.id|stringformat:"s" %}selected{% endif %}>{{ cliente.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filtro_produto" class="form-label">Produto</label>
                        <select name="filtro_produto" id="filtro_produto" class="form-select">
                            <option value="">Todos</option>
                            {% for produto in todos_produtos %}
                                <option value="{{ produto.id }}" {% if valores_filtro.filtro_produto == produto.id|stringformat:"s" %}selected{% endif %}>{{ produto.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="filtro_advogado" class="form-label">Advogado</label>
                        <select name="filtro_advogado" id="filtro_advogado" class="form-select">
                            <option value="">Todos</option>
                            {% for advogado in todos_advogados %}
                                <option value="{{ advogado.id }}" {% if valores_filtro.filtro_advogado == advogado.id|stringformat:"s" %}selected{% endif %}>{{ advogado.get_full_name|default:advogado.username }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-12 text-end">
                        <a href="{% url 'casos:visao_casos_prazo' %}" class="btn btn-secondary">Limpar</a>
                        <button type="submit" class="btn btn-primary">Filtrar</button>
                    </div>
                </div>
            </form>

            <!-- Tabela de Resultados -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>#ID</th>
                            <th>Prazo Final</th>
                            <th>Dias Restantes</th>
                            <th>Título do Caso</th>
                            <th>Cliente</th>
                            <th>Produto</th>
                            <th>Advogado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for caso in casos %}
                            <tr>
                                <td><a href="{{ caso.get_absolute_url }}">{{ caso.id }}</a></td>
                                <td>
                                    {% with prazo=caso.prazo_final_calculado %}
                                        {% if prazo %}
                                            {% with dias_restantes=prazo|days_until %}
                                                <span class="
                                                    {% if dias_restantes < 0 %}prazo-vencido
                                                    {% elif dias_restantes < 7 %}prazo-urgente
                                                    {% elif dias_restantes < 30 %}prazo-atencao
                                                    {% endif %}
                                                ">
                                                    {{ prazo|date:"d/m/Y" }}
                                                </span>
                                            {% endwith %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td>
                                    {% with prazo=caso.prazo_final_calculado %}
                                        {% if prazo %}
                                            {% with dias_restantes=prazo|days_until %}
                                                {% if dias_restantes < 0 %}
                                                    <span class="badge bg-dark">Vencido há {{ dias_restantes|abs_value }} dia(s)</span>
                                                {% elif dias_restantes == 0 %}
                                                    <span class="badge bg-danger">Vence Hoje!</span>
                                                {% elif dias_restantes < 7 %}
                                                    <span class="badge bg-danger">{{ dias_restantes }} dia(s)</span>
                                                {% elif dias_restantes < 30 %}
                                                    <span class="badge bg-warning text-dark">{{ dias_restantes }} dia(s)</span>
                                                {% else %}
                                                    <span class="badge bg-success">{{ dias_restantes }} dia(s)</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    {% endwith %}
                                </td>
                                <td>{{ caso.titulo|truncatechars:50 }}</td>
                                <td>{{ caso.cliente.nome }}</td>
                                <td>{{ caso.produto.nome }}</td>
                                <td>
                                    {% if caso.advogado_responsavel %}
                                        {{ caso.advogado_responsavel.get_full_name|default:caso.advogado_responsavel.username }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="7" class="text-center py-4">Nenhum caso encontrado com os filtros aplicados.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
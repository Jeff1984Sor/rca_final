{# workflow/templates/workflow/workflow_builder.html #}
{% extends 'base.html' %}
{% load static %}

{% block title %}Workflow Builder | Sistema Jurídico{% endblock %}

{% block content %}
{# Este div irá conter todos os dados que precisamos passar do Django para o JavaScript #}
<div id="workflow-data-provider"
     data-workflow-id="{{ workflow.id|default:'' }}"
     data-workflow-nome="{{ workflow.nome|escapejs|default:'' }}"
     data-workflow-cliente-id="{{ workflow.cliente.id|default:'' }}"
     data-workflow-produto-id="{{ workflow.produto.id|default:'' }}"
     data-save-url="{% url 'workflow:salvar_workflow_json' %}"
     data-load-url="{% if workflow.id %}{% url 'workflow:carregar_workflow_json' workflow.id %}{% endif %}"
     data-list-url="{% url 'workflow:lista_workflows' %}"
     data-csrf-token="{{ csrf_token }}">
</div>

<div class="builder-container" x-data="workflowBuilder({
        workflowId: document.getElementById('workflow-data-provider').dataset.workflowId,
        workflowNome: document.getElementById('workflow-data-provider').dataset.workflowNome,
        workflowClienteId: document.getElementById('workflow-data-provider').dataset.workflowClienteId,
        workflowProdutoId: document.getElementById('workflow-data-provider').dataset.workflowProdutoId,
        saveUrl: document.getElementById('workflow-data-provider').dataset.saveUrl,
        loadUrl: document.getElementById('workflow-data-provider').dataset.loadUrl,
        listUrl: document.getElementById('workflow-data-provider').dataset.listUrl,
        csrfToken: document.getElementById('workflow-data-provider').dataset.csrfToken
    })" x-cloak>
    
    <!-- HERO HEADER -->
    <div class="builder-header">
        <h1 class="builder-title">
            <div class="builder-icon">
                <i class="fa-solid fa-diagram-project"></i>
            </div>
            <span x-text="workflowId ? 'Editar Workflow: ' + workflow.nome : 'Criar Novo Workflow'"></span>
        </h1>
    </div>
    
    <!-- FORM BÁSICO (USANDO CLASSES GLOBAIS .card) -->
    <div class="card">
        <div class="card-body">
            <div class="form-row">
                <div class="form-group">
                    <label><i class="fa-solid fa-tag"></i> Nome do Workflow</label>
                    <input type="text" 
                           class="form-control"
                           x-model="workflow.nome"
                           placeholder="Ex: Sinistro RCG - Tokio"
                           @input.debounce.500ms="autoSave">
                </div>
                <div class="form-group">
                    <label><i class="fa-solid fa-building"></i> Cliente</label>
                    <select class="form-control" x-model="workflow.cliente" @change="autoSave">
                        <option value="">Selecione...</option>
                        {% for cliente in clientes %}<option value="{{ cliente.id }}">{{ cliente.nome }}</option>{% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fa-solid fa-box"></i> Produto</label>
                    <select class="form-control" x-model="workflow.produto" @change="autoSave">
                        <option value="">Selecione...</option>
                        {% for produto in produtos %}<option value="{{ produto.id }}">{{ produto.nome }}</option>{% endfor %}
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TIMELINE DE FASES -->
    <div class="fases-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fa-solid fa-list-ol"></i>
                Fases do Workflow
                <span class="badge bg-dark" x-text="workflow.fases.length + ' fase' + (workflow.fases.length !== 1 ? 's' : '')"></span>
            </h2>
            <button class="btn btn-primary" @click="abrirModalFase(null)">
                <i class="fa-solid fa-plus-circle"></i> Nova Fase
            </button>
        </div>
        
        <div class="fases-timeline" id="fases-sortable">
            <template x-for="(fase, index) in workflow.fases" :key="fase.temp_id">
                <div class="fase-card" @click="abrirModalFase(index)">
                    <div class="fase-header">
                        <div class="fase-numero" x-text="index + 1"></div>
                        <div class="fase-actions">
                            <button class="btn-icon action-btn btn-edit" @click.stop="abrirModalFase(index)" title="Editar"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn-icon action-btn btn-delete" @click.stop="deletarFase(index)" title="Deletar"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="fase-nome" x-text="fase.nome"></div>
                    <div class="fase-meta">
                        <span class="badge bg-dark"><i class="fa-solid fa-tasks"></i> <span x-text="fase.acoes.length + ' ' + (fase.acoes.length === 1 ? 'ação' : 'ações')"></span></span>
                        <span class="badge badge-pausar" x-show="fase.pausar_prazo_automaticamente"><i class="fa-solid fa-pause"></i> Pausa Prazo</span>
                    </div>
                </div>
            </template>
            <template x-if="workflow.fases.length === 0">
                <div class="empty-state w-full">
                    <i class="fa-solid fa-layer-group"></i>
                    <h3>Nenhuma fase criada</h3>
                    <p>Clique em "Nova Fase" para começar a construir seu fluxo.</p>
                </div>
            </template>
        </div>
    </div>
    
    <!-- BOTÕES FINAIS -->
    <div class="d-flex justify-end gap-12">
        <a href="{% url 'workflow:lista_workflows' %}" class="btn btn-outline-secondary">
            <i class="fa-solid fa-times"></i> Cancelar
        </a>
        <button class="btn btn-success" @click="salvarWorkflow" :disabled="!isValid">
            <i class="fa-solid fa-save"></i> Salvar Workflow
        </button>
    </div>
    
    <!-- MODAL DE FASE -->
    <div class="modal-overlay" :class="{ 'active': modalFaseAberto }" @click.self="fecharModalFase" x-show="modalFaseAberto">
        <div class="modal-content" @click.stop>
            <div class="modal-header">
                <h2 class="modal-title" x-text="faseEditando !== null ? 'Editar Fase' : 'Nova Fase'"></h2>
                <button class="btn-close" @click="fecharModalFase"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="form-group">
                <label><i class="fa-solid fa-heading"></i> Nome da Fase</label>
                <input type="text" class="form-control" x-model="faseTemp.nome" placeholder="Ex: Análise Inicial">
            </div>
            
            <div class="form-row">
                <div class="form-group"><label><input type="checkbox" x-model="faseTemp.pausar_prazo_automaticamente"> Pausar Prazo Automaticamente?</label></div>
                <div class="form-group" x-show="faseTemp.pausar_prazo_automaticamente">
                    <label>Motivo da Pausa</label>
                    <select class="form-control" x-model="faseTemp.tipo_pausa_padrao">
                        <option value="">Selecione...</option>
                        {% for tipo_pausa in tipos_pausa %}<option value="{{ tipo_pausa.id }}">{{ tipo_pausa.nome }}</option>{% endfor %}
                    </select>
                </div>
            </div>
            
            <div class="acoes-list">
                <div class="d-flex justify-between items-center mb-4">
                    <h3>Ações desta Fase</h3>
                    <button class="btn btn-primary" @click="adicionarAcao"><i class="fa-solid fa-plus"></i> Nova Ação</button>
                </div>
                
                <template x-for="(acao, idx) in faseTemp.acoes" :key="acao.temp_id">
                    <div class="acao-item">
                        <div class="acao-header">
                            <input type="text" class="form-control" x-model="acao.titulo" placeholder="Título da ação">
                            <button class="btn-icon action-btn btn-delete" @click="deletarAcao(idx)"><i class="fa-solid fa-trash"></i></button>
                        </div>
                        <div class="form-group mb-4"><label><i class="fa-solid fa-file-lines"></i> Descrição</label><textarea class="form-control" x-model="acao.descricao" placeholder="Descreva o que deve ser feito..." rows="5"></textarea></div>
                        <div class="form-row">
                            <div class="form-group"><label>Tipo</label><select class="form-control" x-model="acao.tipo"><option value="SIMPLES">Simples</option><option value="DECISAO_SN">Decisão S/N</option><option value="AGUARDAR_DIAS">Aguardar Dias</option></select></div>
                            <div class="form-group"><label>Prazo (dias)</label><input type="number" class="form-control" x-model.number="acao.prazo_dias" min="0"></div>
                            <div class="form-group"><label>Responsável</label><select class="form-control" x-model="acao.tipo_responsavel"><option value="INTERNO">Interno</option><option value="TERCEIRO">Terceiro</option></select></div>
                        </div>
                        <div x-show="acao.tipo_responsavel === 'INTERNO'"><label>Usuário</label><select class="form-control" x-model="acao.responsavel_padrao"><option value="">Automático</option>{% for user in usuarios %}<option value="{{ user.id }}">{{ user.get_full_name|default:user.username }}</option>{% endfor %}</select></div>
                        <div x-show="acao.tipo_responsavel === 'TERCEIRO'"><label>Nome do Terceiro</label><input type="text" class="form-control" x-model="acao.nome_responsavel_terceiro" placeholder="Ex: Cliente, Perito"></div>
                        
                        <div class="form-group mt-4"><label><i class="fa-solid fa-flag"></i> Ao concluir, mudar status para:</label><select class="form-control" x-model="acao.mudar_status_caso_para"><option value="">-- Não alterar --</option>{% for value, display_name in caso_status_choices %}<option value="{{ value }}">{{ display_name }}</option>{% endfor %}</select></div>
                        <div class="mt-4" style="border-top: 1px solid var(--border-light); padding-top: 16px;">
                            <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 12px;"><i class="fa-solid fa-route"></i> Regras de Transição</h4>
                            <div class="form-group" x-show="acao.tipo !== 'DECISAO_SN'"><label>Ao concluir, ir para a fase:</label><select class="form-control" x-model="acao.fase_destino_padrao"><option value="">-- Permanecer na fase atual --</option><template x-for="f in workflow.fases"><option :value="f.temp_id" x-text="f.nome" :disabled="f.temp_id === faseTemp.temp_id"></option></template></select></div>
                            <div x-show="acao.tipo === 'DECISAO_SN'"><div class="form-row"><div class="form-group"><label>Se SIM, ir para:</label><select class="form-control" x-model="acao.fase_destino_sim"><option value="">-- Permanecer --</option><template x-for="f in workflow.fases"><option :value="f.temp_id" x-text="f.nome" :disabled="f.temp_id === faseTemp.temp_id"></option></template></select></div><div class="form-group"><label>Se NÃO, ir para:</label><select class="form-control" x-model="acao.fase_destino_nao"><option value="">-- Permanecer --</option><template x-for="f in workflow.fases"><option :value="f.temp_id" x-text="f.nome" :disabled="f.temp_id === faseTemp.temp_id"></option></template></select></div></div></div>
                        </div>
                    </div>
                </template>
            </div>
            <div class="d-flex justify-end gap-12 mt-4">
                <button class="btn btn-outline-secondary" @click="fecharModalFase">Cancelar</button>
                <button class="btn btn-success" @click="salvarFase">Salvar Fase</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{# Dependências externas continuam aqui #}
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

{# Nosso novo arquivo de script, carregado de forma estática! #}
<script src="{% static 'js/workflow_builder.js' %}"></script>
{% endblock %}
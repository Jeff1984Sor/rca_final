{% extends "base.html" %}
{% load static %}

{% block title %}Alterar Senha | Sistema Jurídico{% endblock %}

{% block content %}
<div class="pwd-container">
    
    <!-- Hero Header Laranja -->
    <div class="pwd-hero">
        <div class="pwd-hero-icon">
            <i class="fa-solid fa-key"></i>
        </div>
        <div class="pwd-hero-text">
            <h1>Alterar Senha</h1>
            <p>Fortaleça a segurança da sua conta definindo uma nova senha.</p>
        </div>
    </div>

    <!-- Form Card -->
    <div class="pwd-card">
        
        <form method="post" id="change-password-form">
            {% csrf_token %}

            <!-- Erros Gerais -->
            {% if form.non_field_errors %}
                <div class="login-error-msg">
                    <i class="fa-solid fa-circle-exclamation"></i>
                    <div>
                        {% for error in form.non_field_errors %}
                            {{ error }}<br>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- 1. Senha Atual -->
            {% with field=form.old_password %}
            <div class="login-form-group">
                <label for="{{ field.id_for_label }}" class="login-label">
                    {{ field.label }} <span style="color:#ef4444">*</span>
                </label>
                <div class="login-input-wrapper">
                    <input type="password" id="{{ field.id_for_label }}" name="{{ field.name }}"
                        class="login-input" placeholder="Digite sua senha atual" required>
                    <button type="button" class="pwd-toggle-btn" data-target="{{ field.id_for_label }}">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
                {% if field.errors %}<div style="color:#ef4444; font-size:0.85rem; margin-top:5px;">{{ field.errors.0 }}</div>{% endif %}
            </div>
            {% endwith %}

            <!-- 2. Nova Senha -->
            {% with field=form.new_password1 %}
            <div class="login-form-group">
                <label for="{{ field.id_for_label }}" class="login-label">
                    {{ field.label }} <span style="color:#ef4444">*</span>
                </label>
                <div class="login-input-wrapper">
                    <input type="password" id="{{ field.id_for_label }}" name="{{ field.name }}"
                        class="login-input" placeholder="Nova senha forte" required>
                    <button type="button" class="pwd-toggle-btn" data-target="{{ field.id_for_label }}">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>

                <!-- Barra de Força -->
                <div class="strength-meter" id="strength-meter">
                    <div class="strength-bar-bg">
                        <div class="strength-bar-fill" id="strength-bar"></div>
                    </div>
                    <div class="strength-label" id="strength-text">
                        <i class="fa-solid fa-circle-info"></i> <span>Digite para ver a força</span>
                    </div>
                </div>

                <!-- Checklist -->
                <div class="req-box">
                    <div class="req-title"><i class="fa-solid fa-list-check"></i> Requisitos mínimos:</div>
                    <ul class="req-list" id="requirements-list">
                        <li class="req-item" data-req="length"><i class="fa-solid fa-circle"></i> Mínimo 8 caracteres</li>
                        <li class="req-item" data-req="uppercase"><i class="fa-solid fa-circle"></i> Letra Maiúscula (A-Z)</li>
                        <li class="req-item" data-req="lowercase"><i class="fa-solid fa-circle"></i> Letra Minúscula (a-z)</li>
                        <li class="req-item" data-req="number"><i class="fa-solid fa-circle"></i> Número (0-9)</li>
                        <li class="req-item" data-req="special"><i class="fa-solid fa-circle"></i> Símbolo Especial (@#$%)</li>
                    </ul>
                </div>

                {% if field.errors %}<div style="color:#ef4444; font-size:0.85rem; margin-top:5px;">{{ field.errors.0 }}</div>{% endif %}
            </div>
            {% endwith %}

            <!-- 3. Confirmar Senha -->
            {% with field=form.new_password2 %}
            <div class="login-form-group">
                <label for="{{ field.id_for_label }}" class="login-label">
                    {{ field.label }} <span style="color:#ef4444">*</span>
                </label>
                <div class="login-input-wrapper">
                    <input type="password" id="{{ field.id_for_label }}" name="{{ field.name }}"
                        class="login-input" placeholder="Repita a nova senha" required>
                    <button type="button" class="pwd-toggle-btn" data-target="{{ field.id_for_label }}">
                        <i class="fa-solid fa-eye"></i>
                    </button>
                </div>
                
                <!-- Feedback de Match -->
                <div id="pwd-match-msg" style="display:none; margin-top:5px; font-size:0.85rem; font-weight:600;"></div>
                {% if field.errors %}<div style="color:#ef4444; font-size:0.85rem; margin-top:5px;">{{ field.errors.0 }}</div>{% endif %}
            </div>
            {% endwith %}

            <!-- Botões -->
            <div style="margin-top: 32px; display: flex; gap: 12px; flex-wrap: wrap;">
                <button type="submit" class="btn-orange" id="submit-btn" style="flex: 1;">
                    <i class="fa-solid fa-floppy-disk"></i> Salvar Nova Senha
                </button>
                <button type="reset" class="btn-outline" style="flex: 1;">
                    <i class="fa-solid fa-rotate-left"></i> Limpar
                </button>
            </div>

        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // 1. Toggle Senha (Olho)
    document.querySelectorAll('.pwd-toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const inputId = this.getAttribute('data-target');
            const input = document.getElementById(inputId);
            const icon = this.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye');
            }
        });
    });

    // 2. Medidor de Força e Requisitos
    const newPassInput = document.getElementById('id_new_password1');
    const meter = document.getElementById('strength-meter');
    const bar = document.getElementById('strength-bar');
    const text = document.getElementById('strength-text');

    if (newPassInput) {
        newPassInput.addEventListener('input', function() {
            const val = this.value;
            
            // Mostrar/Ocultar medidor
            if (val.length > 0) meter.style.display = 'block';
            else meter.style.display = 'none';

            // Cálculo simples de força
            let score = 0;
            if (val.length >= 8) score++;
            if (val.length >= 12) score++;
            if (/[A-Z]/.test(val)) score++;
            if (/[0-9]/.test(val)) score++;
            if (/[^A-Za-z0-9]/.test(val)) score++;

            // Atualiza Barra
            bar.className = 'strength-bar-fill'; // reset
            text.className = 'strength-label'; // reset
            let iconHtml = '';

            if (score <= 1) {
                bar.classList.add('sb-weak'); text.classList.add('sl-weak');
                iconHtml = '<i class="fa-solid fa-triangle-exclamation"></i> Fraca';
            } else if (score <= 3) {
                bar.classList.add('sb-fair'); text.classList.add('sl-fair');
                iconHtml = '<i class="fa-solid fa-circle-minus"></i> Razoável';
            } else if (score <= 4) {
                bar.classList.add('sb-good'); text.classList.add('sl-good');
                iconHtml = '<i class="fa-solid fa-thumbs-up"></i> Boa';
            } else {
                bar.classList.add('sb-strong'); text.classList.add('sl-strong');
                iconHtml = '<i class="fa-solid fa-shield-halved"></i> Muito Forte';
            }
            text.innerHTML = iconHtml;

            // Atualiza Checklist
            updateChecklist(val);
        });
    }

    function updateChecklist(val) {
        const rules = {
            'length': val.length >= 8,
            'uppercase': /[A-Z]/.test(val),
            'lowercase': /[a-z]/.test(val),
            'number': /[0-9]/.test(val),
            'special': /[^A-Za-z0-9]/.test(val)
        };

        for (const [key, met] of Object.entries(rules)) {
            const item = document.querySelector(`.req-item[data-req="${key}"]`);
            const icon = item.querySelector('i');
            if (met) {
                item.classList.add('met');
                icon.className = 'fa-solid fa-circle-check';
            } else {
                item.classList.remove('met');
                icon.className = 'fa-solid fa-circle';
            }
        }
    }

    // 3. Comparação de Senhas
    const confirmInput = document.getElementById('id_new_password2');
    const matchMsg = document.getElementById('pwd-match-msg');

    function checkMatch() {
        if (confirmInput.value.length === 0) {
            matchMsg.style.display = 'none';
            return;
        }
        matchMsg.style.display = 'block';
        if (confirmInput.value === newPassInput.value) {
            matchMsg.style.color = '#16a34a'; // Verde
            matchMsg.innerHTML = '<i class="fa-solid fa-check"></i> Senhas conferem';
        } else {
            matchMsg.style.color = '#ef4444'; // Vermelho
            matchMsg.innerHTML = '<i class="fa-solid fa-xmark"></i> Senhas não conferem';
        }
    }

    if (confirmInput) {
        confirmInput.addEventListener('input', checkMatch);
        newPassInput.addEventListener('input', checkMatch);
    }

    // 4. Loading no Submit
    document.getElementById('change-password-form').addEventListener('submit', function() {
        const btn = document.getElementById('submit-btn');
        btn.style.opacity = '0.7';
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Salvando...';
    });
});
</script>
{% endblock %}
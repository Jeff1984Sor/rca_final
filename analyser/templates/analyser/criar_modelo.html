{# analyser/templates/analyser/criar_modelo.html #}

{% extends "base.html" %}
{% load static %}

{% block content %}
<div style="max-width: 1000px; margin: 30px auto; padding: 20px;">
    
    <!-- CABE√áALHO -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; color: white; margin-bottom: 30px;">
        <h1 style="margin: 0; font-size: 32px;">
            {% if modelo %}
                ‚úèÔ∏è Editar Modelo de An√°lise
            {% else %}
                ‚ûï Criar Novo Modelo de An√°lise
            {% endif %}
        </h1>
        <p style="margin: 8px 0 0 0; opacity: 0.9;">Configure como a IA deve extrair informa√ß√µes dos documentos para Cliente e Produto espec√≠ficos.</p>
    </div>

    <!-- FORMUL√ÅRIO -->
    <form method="POST" style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        {% csrf_token %}

        <!-- SE√á√ÉO 1: INFORMA√á√ïES B√ÅSICAS -->
        <div style="margin-bottom: 40px;">
            <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span style="background: #667eea; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">1</span>
                Informa√ß√µes B√°sicas
            </h2>

            <!-- Nome do Modelo -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                    üìù Nome do Modelo
                </label>
                <input 
                    type="text" 
                    name="nome" 
                    value="{{ modelo.nome|default:'' }}"
                    placeholder="Ex: An√°lise de Avisos de A√ß√£o"
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;"
                    required
                >
            </div>

            <!-- Descri√ß√£o -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                    üìÑ Descri√ß√£o
                </label>
                <textarea 
                    name="descricao"
                    placeholder="Descreva o prop√≥sito deste modelo..."
                    style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-height: 100px; font-family: inherit;"
                >{{ modelo.descricao|default:'' }}</textarea>
            </div>

            <!-- Cliente e Produto -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                        üè¢ Cliente
                    </label>
                    <select 
                        name="cliente" 
                        id="cliente_select"
                        style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px;"
                        required
                    >
                        <option value="">-- Selecione um cliente --</option>
                        {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" {% if modelo.cliente.id == cliente.id %}selected{% endif %}>
                                {{ cliente.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                        üì¶ Produto
                    </label>
                    <select 
                        name="produto" 
                        id="produto_select"
                        style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px;"
                        required
                    >
                        <option value="">-- Selecione um produto --</option>
                        {% for produto in produtos %}
                            <option value="{{ produto.id }}" {% if modelo.produto.id == produto.id %}selected{% endif %}>
                                {{ produto.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Info Box -->
            <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <p style="margin: 0; color: #1565c0; font-size: 14px;">
                    <strong>üí° Dica:</strong> Ao selecionar Cliente e Produto, o sistema carregar√° os campos que voc√™ precisa mapear.
                </p>
            </div>
        </div>

        <!-- SE√á√ÉO 2: INSTRU√á√ïES GERAIS -->
        <div style="margin-bottom: 40px;">
            <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span style="background: #667eea; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">2</span>
                Instru√ß√µes Gerais para a IA
            </h2>

            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333;">
                üìã Orienta√ß√µes Gerais
            </label>
            <textarea 
                name="instrucoes_gerais"
                placeholder="Ex: Voc√™ √© um assistente especializado em an√°lise de documentos jur√≠dicos. Seja preciso e atencioso. Se n√£o encontrar uma informa√ß√£o, retorne 'N√£o encontrado'."
                style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; min-height: 120px; font-family: inherit;"
            >{{ modelo.instrucoes_gerais|default:'' }}</textarea>
            
            <p style="font-size: 12px; color: #999; margin-top: 8px;">
                ‚ÑπÔ∏è Estas instru√ß√µes se aplicam a todos os campos e s√£o enviadas no in√≠cio do prompt.
            </p>

            <!-- Checkbox: Gerar Resumo -->
            <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <input 
                        type="checkbox" 
                        name="gerar_resumo" 
                        {% if modelo.gerar_resumo %}checked{% endif %}
                        style="width: 18px; height: 18px; cursor: pointer;"
                    >
                    <span style="font-weight: 600; color: #333;">
                        üìù Gerar resumo executivo do caso ap√≥s an√°lise
                    </span>
                </label>
            </div>
        </div>

        <!-- SE√á√ÉO 3: CAMPOS A EXTRAIR -->
        <div style="margin-bottom: 40px;">
            <h2 style="font-size: 18px; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                <span style="background: #667eea; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">3</span>
                Campos a Extrair
            </h2>

            <div id="campos_container" style="border: 2px dashed #e0e0e0; border-radius: 8px; padding: 20px; min-height: 100px;">
                <p style="color: #999; text-align: center; margin: 0;">
                    ‚è≥ Selecione um Cliente e Produto para ver os campos dispon√≠veis...
                </p>
            </div>
        </div>

        <!-- BOT√ïES -->
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <a href="{% url 'analyser:listar_modelos' %}" class="btn" style="
                padding: 12px 28px;
                background: #e0e0e0;
                color: #333;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                text-decoration: none;
                display: inline-block;
            ">
                ‚ùå Cancelar
            </a>
            <button type="submit" style="
                padding: 12px 28px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                font-size: 14px;
            ">
                {% if modelo %}
                    üíæ Atualizar Modelo
                {% else %}
                    ‚úÖ Criar Modelo
                {% endif %}
            </button>
        </div>
    </form>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const clienteSelect = document.getElementById('cliente_select');
    const produtoSelect = document.getElementById('produto_select');
    const camposContainer = document.getElementById('campos_container');

    // Fun√ß√£o para carregar campos
    function carregarCampos() {
        const cliente_id = clienteSelect.value;
        const produto_id = produtoSelect.value;

        if (!cliente_id || !produto_id) {
            camposContainer.innerHTML = '<p style="color: #999; text-align: center; margin: 0;">‚è≥ Selecione um Cliente e Produto para ver os campos dispon√≠veis...</p>';
            return;
        }

        // Faz requisi√ß√£o AJAX
        fetch(`/analyser/ajax/campos/?cliente_id=${cliente_id}&produto_id=${produto_id}`)
            .then(response => response.json())
            .then(data => {
                if (data.campos.length === 0) {
                    camposContainer.innerHTML = '<p style="color: #f44336; text-align: center; margin: 0;">‚ùå Nenhum campo dispon√≠vel para esta combina√ß√£o de Cliente e Produto.</p>';
                    return;
                }

                // Renderiza os campos
                let html = '<div style="display: grid; gap: 15px;">';
                
                data.campos.forEach(campo => {
                    const descricaoAtual = document.querySelector(`textarea[name="descricao_${campo.nome_variavel}"]`)?.value || '';
                    
                    html += `
                        <div style="border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; background: #fafafa;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <strong style="color: #333;">${campo.nome_campo}</strong>
                                    <br>
                                    <small style="color: #999;">Tipo: ${campo.tipo_campo}</small>
                                </div>
                                <div style="text-align: right;">
                                    ${campo.is_padrao ? '<span style="background: #4caf50; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üìå Padr√£o</span>' : '<span style="background: #2196f3; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">üéØ Personalizado</span>'}
                                </div>
                            </div>
                            
                            <label style="display: block; font-weight: 600; font-size: 12px; margin-bottom: 5px; color: #666;">
                                üìù Instru√ß√µes espec√≠ficas para extra√ß√£o:
                            </label>
                            <textarea 
                                name="descricao_${campo.nome_variavel}"
                                placeholder="Digite instru√ß√µes espec√≠ficas para este campo (opcional)..."
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; min-height: 60px; font-family: inherit;"
                            >${descricaoAtual}</textarea>
                        </div>
                    `;
                });

                html += '</div>';
                camposContainer.innerHTML = html;
            })
            .catch(error => {
                console.error('Erro:', error);
                camposContainer.innerHTML = '<p style="color: #f44336; text-align: center; margin: 0;">‚ùå Erro ao carregar campos.</p>';
            });
    }

    // Event listeners
    clienteSelect.addEventListener('change', carregarCampos);
    produtoSelect.addEventListener('change', carregarCampos);

    // Carrega campos ao iniciar (se modelo existente)
    carregarCampos();
});
</script>

{% endblock %}
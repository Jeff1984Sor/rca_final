{% extends 'base.html' %}

{% block title %}Analisar Caso #{{ caso.id }} | Analyser{% endblock %}

{% block extra_css %}
<style>
    body { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        background-attachment: fixed; 
    }
    
    .container { 
        max-width: 1200px; 
        margin: 40px auto; 
        padding: 0 20px; 
    }
    
    .hero-header { 
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(20px); 
        border-radius: 24px; 
        padding: 32px 40px; 
        margin-bottom: 32px; 
    }
    
    .hero-title { 
        font-size: 2rem; 
        font-weight: 800; 
        color: #0f172a; 
        margin: 0 0 12px; 
        display: flex; 
        align-items: center; 
        gap: 12px; 
    }
    
    .hero-icon { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        width: 50px; 
        height: 50px; 
        border-radius: 14px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        color: white; 
        font-size: 1.3rem; 
    }
    
    .info-badge { 
        display: inline-flex; 
        align-items: center; 
        gap: 8px; 
        padding: 8px 16px; 
        background: #f1f5f9; 
        border-radius: 10px; 
        font-weight: 600; 
        color: #334155; 
    }
    
    .main-card { 
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(20px); 
        border-radius: 24px; 
        overflow: hidden; 
    }
    
    .card-section { 
        padding: 40px; 
        border-bottom: 1px solid #f1f5f9; 
    }
    
    .card-section:last-child { 
        border-bottom: none; 
    }
    
    .section-header { 
        display: flex; 
        align-items: center; 
        gap: 12px; 
        margin-bottom: 24px; 
    }
    
    .section-header i { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        width: 40px; 
        height: 40px; 
        border-radius: 12px; 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        color: white; 
    }
    
    .section-title { 
        font-size: 1.4rem; 
        font-weight: 700; 
        color: #0f172a; 
        margin: 0; 
    }
    
    .form-label { 
        display: block; 
        font-weight: 600; 
        font-size: 0.95rem; 
        color: #334155; 
        margin-bottom: 8px; 
    }
    
    select, input { 
        width: 100%; 
        padding: 14px 16px; 
        border: 2px solid #e2e8f0; 
        border-radius: 12px; 
        font-size: 1rem; 
    }
    
    .form-group { 
        margin-bottom: 24px; 
    }
    
    .alert { 
        padding: 16px 20px; 
        border-radius: 12px; 
        margin-bottom: 24px; 
        display: flex; 
        align-items: center; 
        gap: 12px; 
    }
    
    .alert-info { 
        background: rgba(79, 172, 254, 0.1); 
        border: 2px solid #4facfe; 
        color: #0369a1; 
    }
    
    .file-grid { 
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
        gap: 16px; 
        margin-top: 20px; 
    }
    
    .grid-item, .grid-item-selectable { 
        position: relative; 
    }
    
    .grid-item-selectable input[type="checkbox"] { 
        display: none; 
    }
    
    .grid-item-link, .grid-item-selectable label { 
        display: flex; 
        flex-direction: column; 
        align-items: center; 
        padding: 20px 12px; 
        background: white; 
        border-radius: 16px; 
        text-decoration: none; 
        color: #1e293b; 
        border: 2px solid #e2e8f0; 
        transition: all 250ms ease-in-out; 
        min-height: 140px; 
        justify-content: center; 
        cursor: pointer; 
        width: 100%; 
        height: 100%; 
    }
    
    .grid-item-link:hover, .grid-item-selectable label:hover { 
        border-color: #667eea; 
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); 
        transform: translateY(-5px); 
    }
    
    .grid-item-selectable input[type="checkbox"]:checked + label { 
        border-color: #10b981; 
        background-color: #f0fdf4; 
        box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2); 
    }
    
    .icon-container { 
        font-size: 2.5rem; 
        margin-bottom: 12px; 
        color: #667eea; 
    }
    
    .item-name { 
        font-size: 0.85rem; 
        text-align: center; 
        word-break: break-word; 
    }
    
    .form-footer { 
        background: #f8fafc; 
        padding: 28px 40px; 
        display: flex; 
        justify-content: flex-end; 
        gap: 16px; 
    }
    
    .btn { 
        padding: 14px 32px; 
        border-radius: 12px; 
        border: none; 
        font-weight: 700; 
        font-size: 1rem; 
        cursor: pointer; 
        text-decoration: none; 
    }
    
    .btn-primary { 
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        color: white; 
    }
    
    .btn-primary:hover { 
        opacity: 0.9; 
    }
    
    .btn-secondary { 
        background: #e2e8f0; 
        color: #475569; 
    }
    
    .btn:disabled { 
        background: #e2e8f0; 
        color: #94a3b8; 
        cursor: not-allowed; 
    }
    
    .selected-count {
        background: #10b981;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .htmx-request .htmx-indicator { 
        display: inline-block; 
    }
    
    .htmx-indicator { 
        display: none; 
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    
    <!-- CABEÇALHO -->
    <div class="hero-header">
        <h1 class="hero-title">
            <div class="hero-icon"><i class="fa-solid fa-robot"></i></div>
            <span>Analisar Caso com IA</span>
        </h1>
        <div style="display: flex; gap: 12px;">
            <div class="info-badge">#{{ caso.id }}</div>
            <div class="info-badge">{{ caso.cliente.nome }}</div>
            <div class="info-badge">{{ caso.produto.nome }}</div>
        </div>
    </div>

    <!-- MENSAGENS -->
    <div id="analyser-messages">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    <i class="fa-solid fa-exclamation-circle"></i>
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- FORMULÁRIO PRINCIPAL -->
    <form id="analysis-form"
          method="POST"
          action="{% url 'analyser:iniciar_analise' caso_id=caso.id %}"
          class="main-card">
        
        {% csrf_token %}

        <!-- SEÇÃO 1: SELEÇÃO DO MODELO -->
        <div class="card-section">
            <div class="section-header">
                <i class="fa-solid fa-brain"></i>
                <h2 class="section-title">1. Selecione o Modelo de Análise</h2>
            </div>

            <div class="form-group">
                <label for="modelo_id" class="form-label">Modelo de Análise *</label>
                <select id="modelo_id" name="modelo_id" required>
                    <option value="">-- Escolha um modelo --</option>
                    {% for modelo in modelos %}
                        <option value="{{ modelo.id }}">{{ modelo.nome }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- SEÇÃO 2: SELEÇÃO DE ARQUIVOS -->
        <div class="card-section">
            <div class="section-header">
                <i class="fa-solid fa-file"></i>
                <h2 class="section-title">2. Selecione os Arquivos</h2>
            </div>

            <div class="alert alert-info">
                <i class="fa-solid fa-info-circle"></i>
                <span>Clique nos arquivos para selecioná-los. Você pode selecionar múltiplos arquivos.</span>
            </div>

            <!-- GRADE DE ARQUIVOS -->
            <div class="file-grid" id="files-grid">
                {% if itens %}
                    {% for item in itens %}
                        {% if item.folder %}
                            <!-- PASTA - Navegação -->
                            <div class="grid-item">
                                <button type="button"
                                        onclick="carregarSubpasta('{{ item.id }}')"
                                        class="grid-item-link">
                                    <div class="icon-container">
                                        <i class="fa-solid fa-folder"></i>
                                    </div>
                                    <span class="item-name">{{ item.name }}</span>
                                </button>
                            </div>
                        {% else %}
                            <!-- ARQUIVO - Checkbox -->
                            <div class="grid-item-selectable">
                                <input type="checkbox"
                                       id="file_{{ item.id }}"
                                       name="arquivos_selecionados"
                                       value="{{ item.id }}"
                                       onchange="atualizarContagem()">
                                <label for="file_{{ item.id }}">
                                    <div class="icon-container">
                                        {% if 'pdf' in item.file.mimeType %}
                                            <i class="fa-solid fa-file-pdf" style="color: #ef4444;"></i>
                                        {% elif 'word' in item.file.mimeType %}
                                            <i class="fa-solid fa-file-word" style="color: #2563eb;"></i>
                                        {% elif 'sheet' in item.file.mimeType %}
                                            <i class="fa-solid fa-file-excel" style="color: #10b981;"></i>
                                        {% else %}
                                            <i class="fa-solid fa-file" style="color: #64748b;"></i>
                                        {% endif %}
                                    </div>
                                    <span class="item-name">{{ item.name }}</span>
                                </label>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div style="grid-column: 1/-1; text-align: center; color: #94a3b8; padding: 40px;">
                        <i class="fa-solid fa-folder-open" style="font-size: 3rem; margin-bottom: 12px; display: block;"></i>
                        <p>Nenhum arquivo encontrado nesta pasta</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- RODAPÉ COM BOTÕES -->
        <div class="form-footer">
            <div class="selected-count" id="selected-count" style="display: none;">
                <span id="count-text">0 arquivo(s) selecionado(s)</span>
            </div>
            <a href="{% url 'casos:detalhe_caso' caso.id %}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
                <i class="fa-solid fa-wand-magic-sparkles"></i> Iniciar Análise
            </button>
        </div>
    </form>

</div>

<script>
function atualizarContagem() {
    const checkboxes = document.querySelectorAll('input[name="arquivos_selecionados"]:checked');
    const count = checkboxes.length;
    const countElement = document.getElementById('selected-count');
    const countText = document.getElementById('count-text');
    const submitBtn = document.getElementById('submit-btn');
    
    if (count > 0) {
        countText.textContent = `${count} arquivo(s) selecionado(s)`;
        countElement.style.display = 'inline-block';
        submitBtn.disabled = false;
    } else {
        countElement.style.display = 'none';
        submitBtn.disabled = true;
    }
}

function carregarSubpasta(folderId) {
    const caso_id = {{ caso.id }};
    fetch(`/analyser/analisar/${caso_id}/arquivos/?folder_id=${folderId}`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('files-grid').innerHTML = html;
        })
        .catch(error => console.error('Erro:', error));
}

// Inicializar na carga da página
document.addEventListener('DOMContentLoaded', atualizarContagem);
</script>

{% endblock %}